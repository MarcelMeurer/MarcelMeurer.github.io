<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logos/icon.png">

<title>Creating a Windows Azure VM Generation V2 from a V1 VM | ITProCloud Blog</title>

<!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Creating a Windows Azure VM Generation V2 from a V1 VM | ITProCloud Blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Creating a Windows Azure VM Generation V2 from a V1 VM" />
<meta name="author" content="mm" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Microsoft has provided different VM sizes over the last years and also introduced the VM Generation V2 at the end of 2019. V2 VMs are different from V1 VMs and have the following advantages:" />
<meta property="og:description" content="Microsoft has provided different VM sizes over the last years and also introduced the VM Generation V2 at the end of 2019. V2 VMs are different from V1 VMs and have the following advantages:" />
<link rel="canonical" href="https://blog.itprocloud.de/Migrate-Azure-V1-VM-to-Azure-V2-VM-In-A-Safe-Way/" />
<meta property="og:url" content="https://blog.itprocloud.de/Migrate-Azure-V1-VM-to-Azure-V2-VM-In-A-Safe-Way/" />
<meta property="og:site_name" content="ITProCloud Blog" />
<meta property="og:image" content="https://blog.itprocloud.de/assets/images/V1-V2-02.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-10-07T00:00:00+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://blog.itprocloud.de/assets/images/V1-V2-02.png" />
<meta property="twitter:title" content="Creating a Windows Azure VM Generation V2 from a V1 VM" />
<script type="application/ld+json">
{"@type":"BlogPosting","image":"https://blog.itprocloud.de/assets/images/V1-V2-02.png","datePublished":"2023-10-07T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.itprocloud.de/Migrate-Azure-V1-VM-to-Azure-V2-VM-In-A-Safe-Way/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://blog.itprocloud.de/assets/images/logos/itpc-logo-bottom-text.png"},"name":"mm"},"url":"https://blog.itprocloud.de/Migrate-Azure-V1-VM-to-Azure-V2-VM-In-A-Safe-Way/","author":{"@type":"Person","name":"mm"},"headline":"Creating a Windows Azure VM Generation V2 from a V1 VM","dateModified":"2023-10-07T00:00:00+02:00","description":"Microsoft has provided different VM sizes over the last years and also introduced the VM Generation V2 at the end of 2019. V2 VMs are different from V1 VMs and have the following advantages:","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

<!--- cookie banner --->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />

<link href="/assets/css/screen.css" rel="stylesheet">

<link href="/assets/css/main.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<!-- <noscript id="deferred-styles"> -->
		<!-- <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous"> -->
	<!-- </noscript> -->


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
    <img src="/assets/images/logos/itpc-logo-bottom-text.png" alt="ITProCloud Blog">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Home</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="/tools"><b>Tools</b></a>
                </li>
				
                <li class="nav-item">
                <a class="nav-link" href="/about">About</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="#allTags">Show all tags</a>
                </li>
				
				<!-- Sorted tag list from https://stackoverflow.com/questions/47135736/jekyll-sort-collections-by-size -->
				<!-- Create a comma-separated string of all the sizes of the collections -->
				
				<!-- Remove last comma of string -->
				
				
				<!-- Split string into array, sort DESC, and remove duplicate elements -->
				
				<!-- Iterate through sizes, and for each size print those collections that have this size -->
				
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
						<li class="nav-item">
						<a class="nav-link" href="/categories#Windows-Virtual-Desktop">Windows Virtual Desktop (58)</a>
						</li>
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
				
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
						<li class="nav-item">
						<a class="nav-link" href="/categories#Azure-Virtual-Desktop">Azure Virtual Desktop (57)</a>
						</li>
					
				  
					
					
				  
					
					
				  
				
				  
					
					
				  
					
					
				  
					
					
				  
					
					
						<li class="nav-item">
						<a class="nav-link" href="/categories#Azure-Monitor">Azure Monitor (11)</a>
						</li>
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
					
					
				  
				
	
				<!-- Original tag list (unsorted) 
				
				
					
						<li class="nav-item">
						<a class="nav-link" href="/categories#Azure-WebApp">Azure WebApp (3)</a>
						</li>
						
					
						<li class="nav-item">
						<a class="nav-link" href="/categories#Azure-VM">Azure VM (2)</a>
						</li>
						
					
						<li class="nav-item">
						<a class="nav-link" href="/categories#PowerShell">PowerShell (9)</a>
						</li>
						
					
				
				-->
								

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://twitter.com/MarcelMeurer"><i class="fab fa-twitter"></i></a>
                </li>
                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.linkedin.com/in/marcel-meurer-15b46b98"><i class="fab fa-linkedin"></i></a>
                </li>
                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://github.com/MarcelMeurer"><i class="fab fa-github"></i></a>
                </li>
                </li>
                <li class="nav-item">
                <a target="_blank" class="nav-link" href="mailto:marcel.meurer@itprocloud.com?subject=Request%20from%20ITProCloud.de"><i class="far fa-envelope"></i></a>
                </li>


                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">ITProCloud Blog</h1>
    <p class="lead">
        Welcome to my blog. I'm writing this blog to share my experiences mainly in IT focused on Microsoft Azure. The blog is part of the ITProCloud GmbH.
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Creating a Windows Azure VM Generation V2 from a V1 VM&url=https://blog.itprocloud.de/Migrate-Azure-V1-VM-to-Azure-V2-VM-In-A-Safe-Way/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=https://blog.itprocloud.de/Migrate-Azure-V1-VM-to-Azure-V2-VM-In-A-Safe-Way/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=https://blog.itprocloud.de/Migrate-Azure-V1-VM-to-Azure-V2-VM-In-A-Safe-Way/&title=Creating a Windows Azure VM Generation V2 from a V1 VM" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>
    </ul>
    
    <div class="sep">
    </div>
    <ul>
        <li>
        <a class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="/assets/images/avatar-mm.png" alt="Marcel">
                        
                    </div>
                    <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left">
                        <a target="_blank" class="link-dark" href="https://blog.itprocloud.de">Marcel</a><a target="_blank" href="https://twitter.com/MarcelMeurer" class="btn follow">Follow</a>
                        <span class="author-description">That's me: Marcel</span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">Creating a Windows Azure VM Generation V2 from a V1 VM</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
            
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            

            
            <img class="featured-image img-fluid" src="/assets/images/V1-V2-02.png" alt="Creating a Windows Azure VM Generation V2 from a V1 VM">
            

            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                <!-- End Toc -->
                <p>Microsoft has provided different VM sizes over the last years and also introduced the VM Generation V2 at the end of 2019. V2 VMs are different from V1 VMs and have the following advantages:</p>
<ul>
<li><strong>UEFI</strong> based (no longer bios-based)</li>
<li><strong>Enhanced OS support</strong></li>
<li><strong>Faster boot and disk support</strong></li>
<li><strong>Advanced Security Features</strong>, like Secure Boot, which ensures the integrity of the boot process, and BitLocker encryption, which enhances data protection</li>
</ul>
<p>Today, I expect that the most deployed VMs are V2, but I still see older V1 versions - including in my own environment. For example, I have several Golden Masters for Azure Virtual Desktop running Windows 10 22/h2 Multi-User. We still see V1 types because of the missing simple migration path. There is no native way in the Azure Portal to do this.</p>
<p>While I wanted to upgrade my Windows 10 Golden Masters to Windows 11, I came to the point of discovering that Windows 11 needs a V2 generation VM (for upgrading, trusted launch, vTPM, and secure boot must also be enabled).</p>
<p>After some research, I figured out that this is really not simple. I found a good blog post from <a href="https://charbelnemnom.com/migrate-gen1-to-gen2-vms-on-azure/">Charbel Nemnom</a>, who provides a step-by-step solution. The solution is still complex, so I decided to write a PowerShell script to handle this complex process more easily.</p>
<h3 id="how-does-it-work">How does it work</h3>
<p>We have our V1 virtual machine we want to convert. Instead of converting, we are building a new virtual machine (V2) with the converted OS disk of our V1 VM. So, in the end, we have two identical VMs: The original V1 VM and the V2 VM. If anything doesn’t work, we still have our original VM.</p>
<p>But takes some time, and the full process takes hours (for the script).</p>
<p>After configuring the script, the script enters the following steps:</p>
<ul>
<li>Deallocates the V1 VM</li>
<li>Creates the new V2 VM with the same size in the same network, optional with trusted launch, secure boot, and vTPM</li>
<li>Makes a snapshot of the V1 OS disk and, from the snapshot, a cloned OS disk (still V1)</li>
<li>Creates an empty V2 disk with the same size and type as the V1 OS disk(this disk is supposed to be our converted OS disk)</li>
<li>Attaches the empty V2 disk and the cloned V1 OS disk to the new V2 VM</li>
<li>The script runs itself on the V2 VM
<ul>
<li>Preparing the partitions of the attached disks</li>
<li>Formatting the partitions</li>
<li>Capturing the cloned V1 OS partition using DISM (that takes some time; in my last conversion, it took nearly 4 hours)</li>
<li>Apply the captured image to the prepared partition of the empty V2 disk</li>
<li>Write the UEFI partition of the formerly empty V2 disk</li>
</ul>
</li>
<li>Deallocates the V2 VM</li>
<li>Detach the attached disks</li>
<li>Swap the OS disk with the no longer empty V2 disk (the now converted OS disk of the V1 VM)</li>
<li>Starting the V2 VM</li>
<li>Doing some cleanup: Deleting the snapshot, the old V2 OS disk, the cloned V1 OS disk</li>
<li><strong>Done</strong></li>
</ul>
<p><img src="../assets/images/V1-V2-02.png" alt="" /></p>
<h3 id="how-to-use-the-script">How to use the script</h3>
<p>Open the script in a PowerShell editor like ISE (or VS Code). Connect to your Azure subscription using <em>Connect-AzAccount</em></p>
<p>Modify the script to match your:</p>
<ul>
<li>Your subscription Id</li>
<li>Your source V1 VM (name and resource group)</li>
<li>Your new V2 VM (name and resource group - ensure to have a different name or resource group; another name of the VM doesn’t reflect the computer name after the process)</li>
<li>Set $enabledTrustedLaunch = $true to also create your V2 VM trusted launch enabled, incl. secure boot and vTPM</li>
<li>The tempDiskSizeGb must be large enough to contain the temporary OS (Server 2022) and the content of the OS disk of the V1 VM (512 should be fine if the disk of the V1 VM is 128 GByte)</li>
</ul>
<p>That’s all. You can run the script and come back after some hours to see the result.</p>
<h3 id="hints">Hints</h3>
<ul>
<li>If the VM size doesn’t support V2, modify the target VM size in the script</li>
<li>If something fails: Cleanup the temporarily created resources manually (snapshot, empty V2 disk, cloned V1 disk, and V2 VM)</li>
<li>Upgrading to Windows 11 multi-user: Check-out this video</li>
</ul>
<h3 id="where-is-the-script">Where is the script</h3>
<p>You can find the script on github: <a href="https://gist.github.com/MarcelMeurer/aab2ef8f36d7c634beebea771f54bf30">Create-V2-From-V1-VM.ps1</a></p>

            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2023-10-07">07 Oct 2023</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/categories#Azure">Azure</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#Azure-Virtual-Desktop">Azure Virtual Desktop</a>
                    </li>
                    
                    <li>
                        <a class="smoothscroll" href="/categories#Windows-Virtual-Desktop">Windows Virtual Desktop</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="/Rollout-AVD-SessionHost-To-Defender-Automatically-with-a-script/"> &laquo; Onboard AVD pooled session hosts to Defender automatically with a script</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="/Migrate-Azure-VM-To-Trusted-Launch/">Updating or cloning a Azure VM with standard security to trusted launch with secure boot and vTPM &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>


    
</div>

<!-- Categories Jumbotron
================================================== -->
<div id="allTags" class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore by tags <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="/categories#Azure-WebApp">Azure WebApp (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-VM">Azure VM (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#PowerShell">PowerShell (9)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-Monitor">Azure Monitor (11)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Log-Analytics">Log Analytics (8)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-AD">Azure AD (4)</a>
                
                    <a class="mt-1 mb-1" href="/categories#OneDrive">OneDrive (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-IoT">Azure IoT (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-Functions">Azure Functions (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-Marketplace">Azure Marketplace (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure">Azure (8)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Windows-Virtual-Desktop">Windows Virtual Desktop (58)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Events">Events (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-Virtual-Desktop">Azure Virtual Desktop (57)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-Webapp">Azure Webapp (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#ADConnect">ADConnect (1)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-5 col-sm-5 text-center text-lg-left">
                Copyright © 2023 ITProCloud Blog 
            </div>
            <div class="col-md-4 col-sm-4 text-center text-lg-left">
                <a href="/Impressum">Impressum</a>/<a href="/ImpressumEn">Imprint</a> - 
                <a href="/privacyDe">Datenschutz</a> - 
				<a href="/privacyEn">Privacy</a>
            </div>
            <div class="col-md-3 col-sm-3 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>



<script src="/assets/js/ie10-viewport-bug-workaround.js"></script> 


<script id="dsq-count-scr" src="//.disqus.com/count.js"></script>


<!-- Start Cookie Plugin -->
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
<script>
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#eaf7f7",
      "text": "#5c7291"
    },
    "button": {
      "background": "#56cbdb",
      "text": "#ffffff"
    }
  },
  "position": "bottom-right",
  "content": {
    "message": 'This website uses cookies to ensure you get the best experience on our website.<br/><a href="/privacyEn">Privacy policy</a><br/><br/>Diese Website verwendet Cookies, um dir mehr Benutzerfreundlichkeit zu bieten. Mit der Nutzung dieser Website stimmst du der Verwendung von Cookies zu.<br/><a href="/privacyDe">Datenschutzerklärung</a><br/><br/> ',
    "href": "/privacyEn"
  }
});
</script>
<!-- End Cookie Plugin -->

</body>
</html>
