<p>Windows gives you access to work with Windows Update on an API level. This is often used to find, download, and install new updates programmatically. That makes special sense in Azure Virtual Desktop, which allows us to trigger Windows Updates in a maintenance Windows where autoscale is disabled (I don’t want to imagine what happens if Windows shuts down during Windows Updates).</p>
<p>Also, my solution, <a href="https://github.com/MarcelMeurer/WVD-Hydra">Hydra for Azure Virtual Desktop</a>, uses the API to install Windows updates. That also includes draining, starting, installing, rebooting, etc. - all that is needed to update an existing host or a golden master. E.g.: Example of the script collection for an update:</p>
<image>
<p>Unfortunately, a Microsoft patch broke the functionality of the Windows Update API. That is documented here: <a href="https://learn.microsoft.com/en-us/windows/release-health/status-windows-11-23h2#3351msgdesc">https://learn.microsoft.com/en-us/windows/release-health/status-windows-11-23h2#3351msgdesc</a></p>
<p>If you have a broken computer, you will see the following error message: Exception from HRESULT: 0x8002802B (TYPE_E_ELEMENTNOTFOUND)
<img src="../assets/images/WSUS-API-01.png" alt="" /></p>
<p>The documentation also explains how to resolve the issue using a KIR (known issue recovery), which requires some handwork or automation. To make this as easy as possible for users of <a href="https://github.com/MarcelMeurer/WVD-Hydra">Hydra for Azure Virtual Desktop</a>, I added the installation of the KIR as part of the “BuiltIn: OS Install Windows Updates”. Finally, it downloads and installs the KIR package and activates it. A final reboot is needed to bring it to work. If you are using the script as part of the script collection (see image above), it will first patch the host and install updates on the second try of running the “BuiltIn: OS Install Windows Updates”.</p>
<p>To get the updated built-in scripts, you can click on the icon in the upper-right corner inside of the scripts page:
<img src="../assets/images/WSUS-API-02.png" alt="" /></p>
<p>Finally, you should have the updated script (reload the site first):
<img src="../assets/images/WSUS-API-03.png" alt="" /></p>
<p>After that, the Windows update procedure is working as expected:
<img src="../assets/images/WSUS-API-04.png" alt="" /></p>
<p>Do you want to adapt your scripts? Here is my implementation. Feel free to use it:</p>
<pre><code># Install Windows security updates directly over the internet. VM downloads the packages directly from Microsoft using the Windows Update service. A restart is required after the installation, which can be done with the script collection &quot;OS Install Windows Updates&quot;.
$updateCollection = New-Object -ComObject Microsoft.Update.UpdateColl
$updateSearcher = New-Object -ComObject Microsoft.Update.Searcher
$updateSession = New-Object -ComObject Microsoft.Update.Session

$updatesKb=&quot;&quot;

LogWriter(&quot;Checking for updates&quot;)
$result = $updateSearcher.Search(&quot;IsInstalled=0 and Type='Software' and IsHidden=0&quot;)

if ($result.Updates.Count -EQ 0) {
	OutputWriter(&quot;No new updates found&quot;)
}
else {
    try {
        $updateDownloader = $updateSession.CreateUpdateDownloader()
        $result.Updates|foreach {
            LogWriter(&quot;Found: $($_.Title)&quot;)
            $updatesKb=$updatesKb+$_.KBArticleIDs+&quot; &quot;
            $updateCollection.Add($_)|Out-Null
        }
        LogWriter(&quot;Downloading updates&quot;)
        $updateDownloader.Updates = $updateCollection
        $updateDownloads = $updateDownloader.Download()
        if (($updateDownloads.HResult -EQ 0) -AND ($updateDownloads.ResultCode -EQ 2)) {
            LogWriter(&quot;Downloads success&quot;)
        }
        else {
            LogWriter(&quot;Downloads failed&quot;)
            Write-host(&quot;ScriptReturnMessage:{Download failed}:ScriptReturnMessage&quot;)
            exit
        }
        LogWriter(&quot;Installing updates&quot;)
        $updateInstaller = New-Object -ComObject Microsoft.Update.Installer
        $updateInstaller.Updates = $updateCollection
        $updateDownloads = $updateInstaller.Install()

        OutputWriter(&quot;Applied updates: $updatesKb&quot;)
    } catch {
        if (($_ -like &quot;*0x8002802B*&quot;) -and (Get-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides&quot; -Name &quot;1931709068&quot; -ErrorAction Ignore).&quot;1931709068&quot; -ne 0) {
            # Update API issue: https://learn.microsoft.com/en-us/windows/release-health/status-windows-11-23h2#3351msgdesc
            $hotFixKirUrl=&quot;https://download.microsoft.com/download/3944f364-6483-49ab-af0d-3e2bd80dedaf/Windows%2011%2022H2%20KB5039302%20240711_20301%20Known%20Issue%20Rollback.msi&quot;
            try {
                LogWriter (&quot;Try to download KIR file to bring Windows Update API back&quot;)
                (New-Object System.Net.WebClient).DownloadFile($hotFixKirUrl, &quot;$env:temp\KIRKB5039302.msi&quot;)
                Start-Process msiexec.exe -Wait -ArgumentList '/I $env:temp\KIRKB5039302.msi /quiet'
                if (-not (Test-Path &quot;HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides&quot;)) {
                    New-Item -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides&quot; -Force -ErrorAction SilentlyContinue
                }
                New-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides&quot; -Name &quot;1931709068&quot; -Value 0 -Force -ErrorAction SilentlyContinue
            } catch {
                LogWriter (&quot;Your system is possible affected by a known issue regarding the Windows Update API. Installing a rollback was not possible due to an error: $_&quot;)
                throw $_
            }
            # A reboot is required
            OutputWriter(&quot;Known issue recovery was applied to the system, but no updates. A restart is required before the next update will work. https://learn.microsoft.com/en-us/windows/release-health/status-windows-11-23h2#3351msgdesc&quot;)
        } else {
            LogWriter (&quot;The KIR installation is installed. If this is not working, another issue prevents the update process: $_&quot;)
            throw $_
        }
    }
}

</code></pre>