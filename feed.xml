<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>ITProCloud Blog</title>
    <description>Welcome to my blog. I&apos;m writing this blog to share my experiences mainly in IT focused on Microsoft Azure. The blog is part of the ITProCloud GmbH.</description>
    <link>https://blog.itprocloud.de/</link>
    <atom:link href="https://blog.itprocloud.de/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Sun, 22 Jun 2025 11:52:55 +0200</pubDate>
    <lastBuildDate>Sun, 22 Jun 2025 11:52:55 +0200</lastBuildDate>
    <generator>Jekyll v3.10.0</generator>
    
      <item>
        <title>WVDAdmin - A native administration Gui for Azure Virtual Desktop (AVD) / Windows Virtual Desktop (WVD)</title>
        <description>&lt;h1 id=&quot;azure-windows-virtual-desktop-administration-with-wvdadmin&quot;&gt;Azure Windows Virtual Desktop administration with WVDAdmin&lt;/h1&gt;

&lt;p&gt;Azure (Windows) Virtual Desktop is generally available under continuous improvement and currently available in the ARM and in the Classic (Fall) version. The ARM version is completely into the Azure Portal.  Sometimes it helps to have a native GUI to make some configuration and - for me, most important - to have an easy image handling to deploy session hosts based on a template VM (golden image approach). Therefore I build a native Windows application to do this, and I&amp;#39;m happy to share it with the community.&lt;/p&gt;

&lt;p&gt;Are you interested in the new &amp;quot;Hydra for Azure Virtual Desktop&amp;quot; solution to manage AVD even better with a lot of automation? &lt;a href=&quot;https://github.com/MarcelMeurer/WVD-Hydra&quot;&gt;Check it out here.&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;../assets/files/WVDAdmin.msi&quot;&gt;&lt;img src=&quot;../assets/icons/download.png&quot; alt=&quot;Download&quot;&gt; &lt;strong&gt;Download the latest release from 04/01/2025&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://youtu.be/fH1_FzNyJf0&quot;&gt;Check out the Youtube video to install and configure WVDAdmin in four steps&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The current version supports a lot of configuration and administration capabilities, and I&amp;#39;m continuously improving WVDAdmin. Some features:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Imaging

&lt;ul&gt;
&lt;li&gt;Create images from golden masters (without destroying the master)&lt;/li&gt;
&lt;li&gt;Handle sysprep and modern app&lt;/li&gt;
&lt;li&gt;Clean-up&lt;/li&gt;
&lt;li&gt;Use of shared image gallery definitions&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Rollout

&lt;ul&gt;
&lt;li&gt;Rollout of multiple session hosts&lt;/li&gt;
&lt;li&gt;Store some base settings encrypted for reuse (domain join name, password, ...)&lt;/li&gt;
&lt;li&gt;Select VM type for each rollout (is not fixed to the host pool)&lt;/li&gt;
&lt;li&gt;Use of ephemeral disks&lt;/li&gt;
&lt;li&gt;Support of a second partition from the master VM (D:)&lt;/li&gt;
&lt;li&gt;Azure Monitor&lt;/li&gt;
&lt;li&gt;AAD only, join to MEM/intune&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;AVD Support

&lt;ul&gt;
&lt;li&gt;Classic AVD&lt;/li&gt;
&lt;li&gt;ARM AVD (Spring Update)&lt;/li&gt;
&lt;li&gt;Migration of resources and session hosts&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Working with AVD resources

&lt;ul&gt;
&lt;li&gt;Add/create/delete&lt;/li&gt;
&lt;li&gt;Host Pools&lt;/li&gt;
&lt;li&gt;Application groups&lt;/li&gt;
&lt;li&gt;Workspaces&lt;/li&gt;
&lt;li&gt;Session hosts&lt;/li&gt;
&lt;li&gt;Working with user sessions&lt;/li&gt;
&lt;li&gt;Disconnect&lt;/li&gt;
&lt;li&gt;Logoff&lt;/li&gt;
&lt;li&gt;Send message&lt;/li&gt;
&lt;li&gt;Shadow&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Session hosts

&lt;ul&gt;
&lt;li&gt;Move between host pools&lt;/li&gt;
&lt;li&gt;Start/Stop/Restart&lt;/li&gt;
&lt;li&gt;Delete - with VM, disk, and nic&lt;/li&gt;
&lt;li&gt;Get error report from AVD agent&lt;/li&gt;
&lt;li&gt;Run scripts remotely on hosts (trigger Windows updates, enable RDP Shortpath, ...)&lt;/li&gt;
&lt;li&gt;Change drain-mode&lt;/li&gt;
&lt;li&gt;Change disk type, e.g.: on-start -&amp;gt; to Premium, after deallocation -&amp;gt; to HDD(for cost savings)&lt;/li&gt;
&lt;li&gt;Remove user assignment&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Virtual machine

&lt;ul&gt;
&lt;li&gt;List all VMs with power state in all subscriptions&lt;/li&gt;
&lt;li&gt;Start/Stop/Restart&lt;/li&gt;
&lt;li&gt;Run scripts remotely on hosts (trigger Windows updates, enable RDP Shortpath, ...)&lt;/li&gt;
&lt;li&gt;Shrink disk to 64 or 32 GByte (to create small images for ephemeral hosts)&lt;/li&gt;
&lt;li&gt;Change disk type, e.g.: on-start -&amp;gt; to premium, after deallocation -&amp;gt; to HDD (for cost savings)&lt;/li&gt;
&lt;li&gt;Create and restore snapshots with a click&lt;/li&gt;
&lt;li&gt;Add an existing domain-joined VM as a session host&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Others

&lt;ul&gt;
&lt;li&gt;Multi-Tenant switch&lt;/li&gt;
&lt;li&gt;Split-Tenant mode&lt;/li&gt;
&lt;li&gt;Search for unused disks and nics&lt;/li&gt;
&lt;li&gt;Rollout VM Scale Sets&lt;/li&gt;
&lt;li&gt;Start and deallocate Scale Set instances&lt;/li&gt;
&lt;li&gt;Re-image Scale Set instances&lt;/li&gt;
&lt;li&gt;Remove customer-managed key (CMK)&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;...&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;installation&quot;&gt;Installation&lt;/h1&gt;

&lt;h2 id=&quot;release-history&quot;&gt;Release History&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;../assets/files/WVDAdmin.msi&quot;&gt;&lt;img src=&quot;../assets/icons/download.png&quot; alt=&quot;Download&quot;&gt; &lt;strong&gt;Download the latest release from 04/01/2025&lt;/strong&gt;&lt;/a&gt;
&lt;a href=&quot;https://youtu.be/fH1_FzNyJf0&quot;&gt;Check out the Youtube video to install and configure WVDAdmin in four steps&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;details&gt;&lt;summary&gt;I&amp;#39;m continuously updating WVDAdmin to make it easier to administrate and deploy WVD, users, and session hosts. Click to see the change history.&lt;/summary&gt;&lt;/p&gt;

&lt;table&gt;&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Release&lt;/th&gt;
&lt;th&gt;Date&lt;/th&gt;
&lt;th&gt;Changes &amp;amp; Notes&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;2.0.05.0&lt;/td&gt;
&lt;td&gt;2025-04-01&lt;/td&gt;
&lt;td&gt;Fix: The AVD API is reporting a non-defined value if you have a &amp;quot;MultiplePersistent&amp;quot; host pool (allowing to add a user to several hosts), the unexpected value caused an exception which is now resolved&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.0.04.0&lt;/td&gt;
&lt;td&gt;2025-03-31&lt;/td&gt;
&lt;td&gt;Change: Correct some typos; update of an Azure package (to access storage accounts)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.0.03.0&lt;/td&gt;
&lt;td&gt;2025-03-24&lt;/td&gt;
&lt;td&gt;Add: Alternativ download URL for the AVD agent to avoid the 502 Bad Gateway error from Microsoft&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.0.02.0&lt;/td&gt;
&lt;td&gt;2025-01-13&lt;/td&gt;
&lt;td&gt;Add: A feature to add a 2nd nic during the rollout to the host. Configure the tag &amp;quot;WVD.Default.VM.2ndNic&amp;quot; with the subnet resource id&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.0.01.0&lt;/td&gt;
&lt;td&gt;2024-12-16&lt;/td&gt;
&lt;td&gt;Add: South Africa as meta data region; Add: VM sizes Ebdsv5- and Ebsv5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.0.00.0&lt;/td&gt;
&lt;td&gt;2024-12-12&lt;/td&gt;
&lt;td&gt;Change: Update to DesktopVirtualization API v. 2024-04-08-preview&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.9.11.0&lt;/td&gt;
&lt;td&gt;2024-10-24&lt;/td&gt;
&lt;td&gt;Fix: Some operations did not worked in the US Goverment cloud (now fixed)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.9.08.0&lt;/td&gt;
&lt;td&gt;2024-08-23&lt;/td&gt;
&lt;td&gt;Fix: Improvement of handling image gallery definitions&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.9.06.0&lt;/td&gt;
&lt;td&gt;2024-07-04&lt;/td&gt;
&lt;td&gt;Change: Change of the API to get a registration token of a pool in response to Microsofts mail: &amp;quot;Update to Microsoft Desktop Virtualization API version 2023-09-05 by August 2, 2024, to avoid potential impact&amp;quot;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.9.05.0&lt;/td&gt;
&lt;td&gt;2024-07-01&lt;/td&gt;
&lt;td&gt;Add: Support for Dls_v5 VM sizes&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.9.04.0&lt;/td&gt;
&lt;td&gt;2024-06-26&lt;/td&gt;
&lt;td&gt;Fix: Issues while generating a host pool registration key is fixed&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.9.03.0&lt;/td&gt;
&lt;td&gt;2024-05-13&lt;/td&gt;
&lt;td&gt;Add: The prompt option while shadowing a user can be deactivated by setting the following reg-dword to 1: HKEY_CURRENT_USER\Software\ITProCloud\WVDAdmin\MstscNoConsent (note: needs addition configurations on the hosts)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.9.02.0&lt;/td&gt;
&lt;td&gt;2024-05-13&lt;/td&gt;
&lt;td&gt;Fix: Issue in imaging script with Bitlocker disks in a few environments&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.9.01.0&lt;/td&gt;
&lt;td&gt;2024-05-09&lt;/td&gt;
&lt;td&gt;Update: Imaging and rollout script to handle a sysprep auto-correction on Server OS&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.8.09.0&lt;/td&gt;
&lt;td&gt;2024-01-23&lt;/td&gt;
&lt;td&gt;Change: Rolling out the monitoring agent will accept any name of forwarding to log analytics in diagnostic settings of the host pool; Update of the imaging and rollout script&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.8.08.0&lt;/td&gt;
&lt;td&gt;2023-11-23&lt;/td&gt;
&lt;td&gt;Change: Update of the deployment and imaging script; Hibernation checkbox for rollout was hidden&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.8.07.0&lt;/td&gt;
&lt;td&gt;2023-11-15&lt;/td&gt;
&lt;td&gt;Add: Support for hibernation if available in the subscription&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.8.06.0&lt;/td&gt;
&lt;td&gt;2023-11-10&lt;/td&gt;
&lt;td&gt;Add: Support for Windows 23H2; Fix: Failure during the copy of an image to an image gallery; Change: Update of the deployment and imaging script&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.8.05.0&lt;/td&gt;
&lt;td&gt;2023-10-13&lt;/td&gt;
&lt;td&gt;Add: Support for different VM sizes (Bas_v2, Bls_v2, Bats_v2, etc.); Update of the imaging script&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.8.01.0&lt;/td&gt;
&lt;td&gt;2023-09-19&lt;/td&gt;
&lt;td&gt;Add: Support to capture trusted launch VMs directly into an Azure Compute Gallery; More reliable rollout of session hosts working around some of the AVD-agent issues&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.63.0&lt;/td&gt;
&lt;td&gt;2023-07-09&lt;/td&gt;
&lt;td&gt;Fix: Update of the installation script to install WinGet/Microsoft Package Manager applications&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.62.0&lt;/td&gt;
&lt;td&gt;2023-06-28&lt;/td&gt;
&lt;td&gt;Add: New deployed hosts: In the first minutes, the correct start of the BootloaderAgent is monitored (if the service is not running, the service will be started)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.61.0&lt;/td&gt;
&lt;td&gt;2023-06-19&lt;/td&gt;
&lt;td&gt;Add: Modification to keep settings through Intune in the template&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.60.0&lt;/td&gt;
&lt;td&gt;2023-06-07&lt;/td&gt;
&lt;td&gt;Fix: In some cases a remote app icon crashed the application&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.59.0&lt;/td&gt;
&lt;td&gt;2023-05-06&lt;/td&gt;
&lt;td&gt;Add: Custom scirpt extension can ask for a parameter (see CustomScript-WithParameterString.ps1)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.58.0&lt;/td&gt;
&lt;td&gt;2023-04-07&lt;/td&gt;
&lt;td&gt;Add: Ressetting the SCCM/MECM configuration during imaging; speed-up imaging for Windows 11 22H2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.57.0&lt;/td&gt;
&lt;td&gt;2023-04-03&lt;/td&gt;
&lt;td&gt;Fix: A DLL was missing to read the Winget data (current packages)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.56.0&lt;/td&gt;
&lt;td&gt;2023-03-25&lt;/td&gt;
&lt;td&gt;Add: Update the imaging script to be even more resilient to sysprep issues. Sysprep is now monitored, and some workarounds for sysprep are triggered automatically in case of a sysprep error&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.55.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Deployment tags with an empty value are now set&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.54.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: If a larger disk size is used as the image: the last partition will be automatically extend; Add: Gallery images for Windows 10 22H2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.52.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Better handling for AAD only joined VM&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.51.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for Central India as meta-data location&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.50.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Workaround to image Windows 11 22H2 (there is a bug in the sysprep process)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.49.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Secure boot enabled hosts are now supporting &amp;#39;Guest Attestation&amp;#39; (automatically installed)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.48.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Support for Azure Disk Encryption fixed (ADE); Change to the PowerShell script: Avoiding a sysprep issue with the desired state configuration&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.47.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: GUI, overlapping checkbox for use newes agent and secure boot&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.46.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Additional Galley images; Add: Download newest AVD agent during the rollout (instead of using the agent stored in the image)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.45.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Galley images are only shown if a custom image exist&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.44.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Australia East as meta-data location&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.43.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for FX-series VM size&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.42.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: You can filter on the &amp;#39;Virtual Machines&amp;#39; by the string &amp;#39;!orphanhosts&amp;#39;. That shows all VMs created by WVDAdmin or Hydra as a session host but currently not part of any seen host pool (used internally the tags WVD.Path or AVD.Path); Change: Modify WVD.Path/AVD.Path in another way while moving a session host to another host pool&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.41.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Japan East as meta-data location&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.40.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Move host pool: The user assignment was not always kept;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.39.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: You can enable &amp;quot;Secure Boot&amp;quot; for marketplace images and for Custom Images in an Azure Compute Gallery (configure the VM image definition to support Secure Boot before copying a captured image to the gallery definition)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.38.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Deploy Azure market place images; Add: Show assigned users in the session hosts tab&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.37.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Adding VM Size: NCasT4_v3-series; Add: All new created VMs are flagged to delete nic and disk if the VM is deleted in the Azure Portal&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.35.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: NoTags-mode. Prevents WVDAdmin to set the default tags on new session hosts, scale sets and images. Set HKEY_CURRENT_USER\Software\ITProCloud\WVDAdmin\NoTags to 1 (NoTags is REG_DWORD32)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.34.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Having custom script for imaging and deployment based on the tenant friendly name if running in the multi-AAD-tenancy mode &lt;a href=&quot;../Windows-Virtual-Desktop-Windows-Virtual-Desktop-Administration-for-CSP-and-Consulting-Partners&quot;&gt;Follow this link&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.33.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Dark-mode. Set HKEY_CURRENT_USER\Software\ITProCloud\WVDAdmin\DarkMode to 1 (DarkMode is REG_DWORD32)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.32.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Using AAD-only expected the unnecessary field domain FQDN and the rollout button was greyed out in some situations&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.31.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for NVadsA10v5 VM types&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.30.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: You can now deploy a host in a named availability zone (normally, the zone is (optional) automatically calculate to spread hosts around different zones&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.29.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: WVDAdmin stores the last rollout configuration and now (that is new), the last image, host pool, VM-size, storage type, etc.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.28.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Gettting the diagnostic setting on a host pool changed (updated API)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.25.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Change: Configure diagnostic settings now enables all logs&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.24.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: You can directly re-assign a user to a VDI session host or delete an assignment (on the session host tab change or delete the user asssignment)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.23.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: A new tab shows the name of the current background processes (Jobs)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.22.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: In some cases a VM-Scale-Set Instances where not shown and crashes the application&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.21.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: VM Scale Set rollout issue&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.20.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Experimental support for building session hosts based on a secure boot Golden Master&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.19.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: VM sizes for D and E series V5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.18.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Change the VM size for multiple VMs (Azure -&amp;gt; Virtual Machines); New images are created with tags including the timestamp and resource ID of the master VM&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.17.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Change: The API permission for Azure AD Graph is no longer needed for the service principal if you are using WVDAdmin for AVD (spring edition)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.16.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Session host rollout will set an additional tag to VM, Nic and Disk: WVD.Host=&lt;Name of session host&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.15.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: If you deallocate a VM without tags, the VM is deallocate but an error message is/was shown (Changing power state of Azure vm was not successful Object reference not set to an instance of an object.)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.14.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Change: Uninstallation of th RDAgent (if you capture a session host is now faster)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.13.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Join MEM/Intune while rolling out session hosts; Add: Function to shrink a disk of a VM to 32 GByte to rollout cheaper instances and/or use smaller instances with ephemeral disks&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.11.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Optimization to capture a session host for a new image&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.09.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Change: Change the rollout process to be more reliable if you deploy a lot of hosts at once; Fix: Secrets can now have special characters&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.05.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: The windows can now be resized to full-screen&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.01.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support to show subscription name in rollout and imaging tab (set HKEY_CURRENT_USER\SOFTWARE\ITProCloud\WVDAdmin\ShowSubscriptionName to (reg-dword))&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7.00.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support to deploy AAD-only session hosts; Fix: Resize of V2 VM disks&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;../assets/files/WVDAdmin_1.6.99.0.msi&quot;&gt;1.6.99.0&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Meta-data location for Canada and the UK&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.98.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Resize the application window height in case you have a smaller resolution (&amp;lt;828 px)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.97.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Remove a Customer Managed Key (CMK) from a VM / Disk&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.96.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for the Edv4- and Edsv4-Serie&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.95.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: You can now use CTRL+C in each table to copy the content of the selected column&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.94.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: An import of the registry settings failed if the windows decryption key is other than the user who exported the settings&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.92.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: A session host could be visible in the session host tab of anonter hostpool if the resource id of the host pools starts with the same string&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.91.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Create and restore snapshots of a VM (right click the VM in the Azure node)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.90.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Function to shrink a disk of a VM to 64 GByte to rollout cheaper instances and/or use smaller instances with ephemeral disks&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.89.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Workaround to fix an issue in the Azure API querying VM. In subscriptions with a lot of VMs an error message could given back from the API which will be workaround with this version. Original error message from Azure: Resource provider &amp;#39;Microsoft.Compute&amp;#39; failed to return collection response for type &amp;#39;virtualMachines&amp;#39;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.88.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Option to rollout virtual machines based on an image without joining to WVD/AVD (for servers, new golden masters, ...), Update: Newest PowerShell script for generalizing and deployment to 3.0: &lt;a href=&quot;https://blog.itprocloud.de/assets/files/AutoUpdate/Scripts/ITPC-WVD-Image-Processing.ps1.txt&quot;&gt;ITPC-WVD-Image-Processing.ps1&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.87.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Option to switch on &amp;quot;Power on connect&amp;quot; for pooled (and assigned) host pools (preview feature)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.86.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Option to directly roll-out new session hosts with actice Azure Disk Encryption (ADE) - See &amp;quot;secret features&amp;quot; below&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.83.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Update of ITPC-WVD-Image-Processing.ps1 - if you run it from a share with prepared MSIs, the MSIs are ignored and downloaded directly from Microsoft&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.82.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Script to enable screen capture protection per session host&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.81.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Localized time for the session list (WVD classic)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.80.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Message box before logging users off&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.79.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: VM list in the &amp;quot;Virtual Machines&amp;quot; node are now showing the private IP&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.77.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Official support for meta-data regions: West Europe and North Europe&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.76.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: New applications failed to create in an existing application group&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.75.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: In some cases session hosts are not displayed in the session hosts node (no matching resource id - upper-case / lower-case issue)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.73.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Automatically change the disk type on start/stop: Add a tag &amp;quot;&lt;a href=&quot;../Changing-the-disk-type-automatically-while-starting-or-deallocating-a-session-host,-VM-for-WVD&quot;&gt;WVD.AdvDiskType&lt;/a&gt;&amp;quot; to a VM with the value &amp;quot;StandardSSD_LRS&amp;quot; or &amp;quot;Premium_LRS&amp;quot;. On the stop, the disk is converted to HDD (lowes costs), and on start, the disk is converted to the named type.  Works only with WVDAdmin (not from the Azure Portal or scaling solutions)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.72.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Fix for a sysprep failure (Sysprep data was marked corrupt; cannot proceed) in the ITPC-WVD-Image-Processing.ps1 script; Add: Better handling for shutdown/start/delete VM tasks in the Virtual Machines node&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.71.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: The disk size for new session hosts can be selected (optional) to have a higher IOPS performance&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.70.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: For preview only: Checkbox to enable upcoming &amp;quot;Start on connect feature&amp;quot;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.69.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Open files are not shown if different storage accounts in different subscriptions are used under some circumstances&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.68.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: West Europe as metadata location (can only be used if the subscription is in an appropriate preview program); Add: Some scroll bars to list boxes&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.66.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Rollout from session hosts based on a share image gallery item failed in another subscription then the subscription containing the gallery image&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.65.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Security query before hosts are started, stopped or restarted&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.64.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Install session host optionally with Azure Monitor Extension or sepago Azure Monitor (for Azure Monitor Extension: Make sure that you have configured the target host pool correctly once: Right-click -&amp;gt; Configure Diagnostic settings)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.62.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: You can now terminate file handles to an Azure Storage (orphaned handles avoiding a user to log in with its FSLogix profile) - Service Principal needs contributor permissions to the storage account&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.61.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: VC++ runtime if you use the destkop installer&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.60.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Manage your Virtual Machines like session hosts: Click on Azure - Virtual Machines to list all VMs in your subscriptions (note: data for the VMs are are delayed (resource graph))&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.59.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Change: Rollback of advanced logging of create VM / create Image Powershell script: Shows unimportand messages as an error with existing images&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.57.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: You can enable diagnostic settings directly on a host pool, appgroup and workspace (right-click); Fix: Sometimes reading the state of a script extension is not directly possible. This cause that the WVDAdmin log shows an error even if everything works as expected&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.56.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Change: Single session nodes are not listed under the session host node if more then 100 sessions exist to speed up WVDAdmin - all sessions are still in the session list&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.54.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Function to delete unused disks and nics; Add: More logging for the rollout of session hosts; Add: New VM-types, like L4s_v2, ...&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.53.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Add session hosts automatically to Loadbalancer Backend Pools; Add: If a VM resource is unavailable, the first alternative VM size will be tried&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.51.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Custom script to install &lt;a href=&quot;https://www.sepago.de/en/azure-monitor-en&quot;&gt;Azure Monitor for WVD from sepago&lt;/a&gt; to existing session hosts&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.50.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for Dhsv3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.46.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: You can now rollout new session hosts with accelerated network configuration, Change: NICs are now created with the name of the VM&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.45.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Add session hosts automatically to ASGs&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;a href=&quot;../assets/files/WVDAdmin_1.6.42.msi&quot;&gt;1.6.42.0&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for Dasv4-series&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.41.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Experimental feature: Add applications to session hosts from Windows Package Manager repository&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.40.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Change: Having a script-path for building images is no longer needed. If you leave the text box empty, the local script coming with WVDAdmin will be used and directly send to the VM&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.35.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: On a session host &amp;gt; State &amp;gt; Mouse over will show the health report of the host&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.34.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: The drop-down list &amp;quot;Feature release&amp;quot; was not shown correctly. Feature release is the selector between the different WVD/AVD versions like Fall (WVD classic) and Spring (WVD modern on ARM)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.32.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: You can run scripts on multiple classic session hosts: Win Updates: Install new available updates; Custom script: Custom script located in the program files folder of WVDAdmin&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.30.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Sorting order for WVD/AVD resources&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.29.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for Eav4 and Easv4-series&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.28.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Speed up adding a lot of VMs to the treeview&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.27.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for using availability zones. Select it from the drop-down list right to the resource group list&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.26.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: You can run scripts on multiple ARM session hosts: Win Updates: Install new available updates; Custom script: Custom script located in the program files folder of WVDAdmin&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.24.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Multi selection and action on session hosts for ARM if you select a session host container; Fix: Scale Set instances wasn&amp;#39;t shown in 1.6.23&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.23.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: New image was not visualized in the tree view after creation&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.22.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for shared image galleries: Add a shared image gallery from the Azure Portal into a resource group managed by WVDAdmin. In WVDAdmin right-click an existing image and select &amp;quot;copy to shared image gallery&amp;quot;. An image can be rolled-out right clicking the shared image&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.21.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Double-click on the tag Logs, Sessions or Sessions V2 enlarge the part of the windows (double-click again to revert)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.18.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: API change from Microsoft cause that updating a host pool property fails if the location is written like &amp;quot;Central US&amp;quot; (centralus is no problem); Add: First version able to deploy session hosts from images in a image gallery&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.16.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Session hosts icons  are now based on the availability state; Fix: Enumerating thousands of sessions with thousands of session hosts takes longer as expected (&amp;gt; 4 minutes)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.14.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support US Government Cloud. Activate: Add a new string Reg_SZ &amp;quot;Environment&amp;quot; with value &amp;quot;US&amp;quot; to HKCU\SOFTWARE\ITProCloud\WVDAdmin&amp;quot;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.12.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for VM types: Dv4 and Dsv4-series, Ev4 and Esv4-series&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.11.0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: WVD/AVD ARM resources are deployed with the tags; Workspaces and host pools are separated by subscription name&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.9.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Generating toke for Spring host pool fails sometimes (Error: ExpirationTime value must be between one hour and 30 days from now&amp;quot;  - An error occurred while gathering an WVD2 token from backend: Object reference not set to an instance of an object.)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.5.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for DD_v2 and DDS_V4 virtual machine types; Fix: Forwarding from the WVD/AVD API cause a authentication lost (error 401, 403 reading resources in the FALL update)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.4.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for GEN2 virtual machines&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.2.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: New naming feature for new session host. Default (is): Name for a session host is the highest matching name +1; new concept (must be enabled): Name for a session host is the next free name. To enable add a reg dword to HKCU\Software\ITProCloud\WVDAdmin Name:NamingMode and value to &amp;quot;1&amp;quot;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.1.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Default session limit for V2 host pool is now 999999&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6.0.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Change: The tag WVD.Path is aligned to Microsoft naming of &amp;quot;tenant&amp;quot; and &amp;quot;host pool&amp;quot; for the spring update. Tenant=resource group name and no longer subscription name&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.5.9.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Load assigned users button to the app group tab (fall update)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.5.7.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: You can join existing VM&amp;#39; to a host pool (VMs must be domain joined and not in a host pool right now)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.5.6.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: You can now move session host around host pools not created with WVDAdmin (it downloads the necessary files automatically); you can join existing VM&amp;#39; to a host pool (VMs must be domain joined)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.5.5.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Enumerating VMs was endless in some circumstance&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.5.4.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Migration from Fall to Spring Update; moving session hosts to another host pool&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.5.3.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Improvement updating the treeview&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.5.0.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add:  &lt;a href=&quot;https://blog.itprocloud.de/Windows-Virtual-Desktop-Spring-Update,-Spring-Release&quot;&gt;Supporting the WVD Spring Release / Spring Update&lt;/a&gt; ; Some user operations from the session grid are now async; Fix: Spontaneous resize of the windows if data are reloaded&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.4.9.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Filter users, session hosts and host pools in the overview of sessions&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.4.8.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support to add users by groups from Azure Active Directory, including an AAD browser (check my &lt;a href=&quot;https://blog.itprocloud.de/Windows-Virtual-Desktop-Add-Users-and-Groups-to-WVD/&quot;&gt;blog post&lt;/a&gt; and configure the service principal to use this feature)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.4.6.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: New VM sizes; all new scale sets are deployed as really scalable version (up to 600 instances each)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.4.4.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Service Principal Keys with some special characters are working now; Add: Faster loading of resources from WVD/AVD and Azure backend&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.4.2.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for NVv4 VM sizes (based on AMD Radeon Instinct  MI25-GPU); support to set custom Azure tags for resources while deploying resources&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.4.0.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: From an older version, disks are deployed as standard-hdd even if premium-disk was selected; Change: Connection views are now located parallel to the logging list on the bottom (tenant-view); Add: Function to check for an updated version via &lt;a href=&quot;../assets/files/WVDAdmin.xml&quot;&gt;https://blog.itprocloud.de/assets/files/WVDAdmin.xml&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.3.6.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: New tag for session hosts: WVD.Path - used by &lt;a href=&quot;http://loganalytics.sepago.com/&quot;&gt;Azure Monitor for WVD&lt;/a&gt; and &lt;a href=&quot;https://github.com/MarcelMeurer/Project-MySmartScale&quot;&gt;Azure Autoscale for WVD - aka Project MySmartScale&lt;/a&gt; if an installed language pack conflicts with the Microsoft RDAgent (read this &lt;a href=&quot;https://blog.itprocloud.de/Windows-Virtual-Desktop-Language-Packs-Detecting-Host-Pool-and-Tenant-Name/&quot;&gt;post&lt;/a&gt; to learn more)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.3.5.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Allow an local admin to shadow a user session (WVDAdmin needs direct access to the session host via RDP)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.3.4.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Networks are now listed as VNET/SUBNET in the rollout tab&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.3.3.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for a special mode if your WVD/AVD tenant and the session hosts in two different Azure Active Directory tenants&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.3.1.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: WVDAdmin crashed if 1.3.0 is your first version of WVDAdmin (HKEY_CURRENT_USER\Software\ITProCloud doesn&amp;#39;t exist while checking for multi-tenancy mode)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.3.0.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: AAD multi-tenancy mode (drop down list to handle different AADs) - &lt;a href=&quot;https://blog.itprocloud.de/Windows-Virtual-Desktop-Windows-Virtual-Desktop-Administration-for-CSP-and-Consulting-Partners/&quot;&gt;https://blog.itprocloud.de/Windows-Virtual-Desktop-Windows-Virtual-Desktop-Administration-for-CSP-and-Consulting-Partners&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.2.8.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: If you click a tenant a tenant wide list of sessions is listed.  Logoff or send messages to multiple sessions&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.2.7.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: The main window of the application is now resizeable&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.2.5.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for Scale Sets (with normal and ephemeral disks) -&amp;gt; see below&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.2.4.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for availability sets&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.2.3.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Support for automatic and static assigned host pools&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.2.1.00&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;&lt;a name=&quot;v121-note&quot;&gt;&lt;/a&gt;Fix: Logging of rollout parameter by Azure custom extension is removed to avoid logging secrets&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.0.0.30&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: Rollout - OU can now be empty to join the default OU&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.0.0.29&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Supporting &amp;quot;special license mode&amp;quot; to save up to 50% on compute-cost (&lt;a href=&quot;https://docs.microsoft.com/en-us/azure/virtual-desktop/apply-windows-license&quot;&gt;https://docs.microsoft.com/en-us/azure/virtual-desktop/apply-windows-license&lt;/a&gt;)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.0.0.26&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Add: Template VM can now be a VM with a standard disk (non-managed)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.0.0.25&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Fix: If you delete a VM the OS disk will deleted as well&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.0.0.23&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;Support for ephemeral  disks&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.0.0.22&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;td&gt;First published version - without auto-update of WVDAdmin&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;

&lt;p&gt;&lt;/details&gt;&lt;br/&gt;&lt;/p&gt;

&lt;h2 id=&quot;configuration&quot;&gt;Configuration&lt;/h2&gt;

&lt;h2 id=&quot;service-principal-functional-account&quot;&gt;Service principal (functional account)&lt;/h2&gt;

&lt;p&gt;To work with the GUI, you need a service principal (function account) with permission to administrate access to the AVD and Azure resources. I decide to use a service principal to avoid confusion if my Azure AD user is only a guest account in the AVD tenant I have to administrate and easily switch between different tenants.&lt;/p&gt;

&lt;p&gt;To create a service principal, go to your Azure AD -&amp;gt; &lt;a href=&quot;https://portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps&quot; target=&quot;_blank&quot;&gt;App registration&lt;/a&gt; -&amp;gt; New registration and type a name for your principal like &amp;quot; svc_WVDAdmin&amp;quot; and press &amp;quot;register&amp;quot;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/documentation-001.png&quot; alt=&quot;documentation-001&quot;&gt;&lt;/p&gt;

&lt;p&gt;Click on &amp;quot;certificates &amp;amp; secrets&amp;quot;. Click &amp;quot;new client secret&amp;quot;, select a validity period and a description (like &amp;quot;Key01&amp;quot;). Press &amp;quot;add&amp;quot;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/documentation-002.png&quot; alt=&quot;documentation-002&quot;&gt;&lt;/p&gt;

&lt;p&gt;Copy the generated key directly - it will never be displayed again. Note the key for later.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/documentation-003.png&quot; alt=&quot;documentation-003&quot;&gt;&lt;/p&gt;

&lt;p&gt;To assign users to app groups, the service principal needs one API permissions to get the users and groups from Azure AD (optional):&lt;/p&gt;

&lt;p&gt;Add the permission &amp;quot;Microsoft Graph&amp;quot; -&amp;gt; Application Permission -&amp;gt; Directory.Read.All&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/SP-PermissionToReadDirectoryObjects-01b.png&quot; alt=&quot;AADBrowser&quot;&gt;&lt;/p&gt;

&lt;p&gt;To consent, the permission and administrator of Azure AD have to grant this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/SP-PermissionToReadDirectoryObjects-02.png&quot; alt=&quot;AADBrowser&quot;&gt;&lt;/p&gt;

&lt;p&gt;Go to &amp;quot;Overview&amp;quot;. Note the &amp;quot;Application (client) ID&amp;quot; and the &amp;quot;Directory (tenant) ID&amp;quot; as well.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/documentation-004.png&quot; alt=&quot;documentation-004&quot;&gt;&lt;/p&gt;

&lt;p&gt;You now have all data for your service principal:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Tenant id&lt;/li&gt;
&lt;li&gt;Service principal id (application id)&lt;/li&gt;
&lt;li&gt;Service principal key&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;avd-permissions&quot;&gt;AVD permissions&lt;/h2&gt;

&lt;p&gt;This chapter is for AVD ARM / Spring. &lt;a href=&quot;#azure-resource-permissions&quot;&gt;Skip&lt;/a&gt; this chapter if you only work with WVD Classic (Fall).&lt;/p&gt;

&lt;p&gt;The service principal needs permission to add and modify AVD resource objects (host pools, workspaces, app groups). To assign users and groups to app groups, the service principal needs the owner role on the resource groups you want to use for your AVD environment. Add the service principal in the next step and use the &lt;strong&gt;owner&lt;/strong&gt; role.&lt;/p&gt;

&lt;h2 id=&quot;register-resource-provider&quot;&gt;Register Resource Provider&lt;/h2&gt;

&lt;p&gt;If you have never worked with AVD, you have to register the AVD resource provider once. To do that, go to the Azure portal -&amp;gt; subscriptions -&amp;gt; select your subscription -&amp;gt; Resource providers&lt;/p&gt;

&lt;p&gt;Search for &amp;quot;Microsoft.DesktopVirtualization&amp;quot; and click on &amp;quot;Register&amp;quot;.
&lt;img src=&quot;../assets/images/WVDAdmin/documentation-015.png&quot; alt=&quot;documentation-015&quot;&gt;&lt;/p&gt;

&lt;h2 id=&quot;azure-resource-permissions&quot;&gt;Azure resource permissions&lt;/h2&gt;

&lt;p&gt;The service principal needs permission to subscriptions or resource groups to manage your AVD resources, imaging template VM and rollout session hosts. &lt;/p&gt;

&lt;p&gt;Open the Azure portal and go to the resource groups you want to use or to the subscriptions. In each resource group/subscription, click &amp;quot;Access control (IAM)&amp;quot; -&amp;gt; select &amp;quot;Add&amp;quot; -&amp;gt; Add role assignment. Select &amp;quot;owner&amp;quot; and search in &amp;quot;Select&amp;quot; for your service principal name. Click on the principal and save the settings.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; Owner is needed to assign users to app groups. For other resources, &amp;quot;contributor&amp;quot; is fine.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/documentation-006.png&quot; alt=&quot;documentation-006&quot;&gt;&lt;/p&gt;

&lt;p&gt;The service principal must have permissions to your virtual network (vnet) to assign new VMs to the right subnet. Go to your vnet, click &amp;quot;Access control (IAM)&amp;quot; -&amp;gt; select &amp;quot;Add&amp;quot; -&amp;gt; Add role assignment. Select &amp;quot;contributor&amp;quot; and search in &amp;quot;select&amp;quot; for your service principal name. Click the principal and save the settings. You could skip this step if you assigned the service principal to the subscription or to the resource group containing your vnet.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/documentation-007.png&quot; alt=&quot;documentation-007&quot;&gt;&lt;/p&gt;

&lt;h2 id=&quot;prepare-your-native-active-directory&quot;&gt;Prepare your &amp;quot;native&amp;quot; Active Directory&lt;/h2&gt;

&lt;p&gt;Today each session host must be part of a &amp;quot;native&amp;quot; active directory domain (or have to use the domain services). To add new session hosts unattended, we need an administrative user account to add a computer object to the active directory domain. You can use an existing one, or you can create a new service user:&lt;/p&gt;

&lt;p&gt;Open &amp;quot;Active Directory Users and Computers&amp;quot; and create a user object with a complex password, and set a password to &amp;quot;never expire&amp;quot; (if you fine with this). I added the user &lt;a href=&quot;mailto:srv_WVD-Join@itprocloud.de&quot;&gt;srv_WVD-Join@itprocloud.de&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Delegate permission for the user to an OU. I found a really good blog post from &lt;a href=&quot;https://twitter.com/prajwaldesai&quot;&gt;Prajwal Desai&lt;/a&gt;. Check out hist post on (external web site): &lt;a href=&quot;https://www.prajwaldesai.com/allow-domain-user-to-add-computer-to-domain/&quot; target=&quot;_blank&quot;&gt;Method 2 – Delegate rights to user/group using Active Directory Users and Computers&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In my case I added my function account to: &amp;quot;OU=WVD,OU=Azure,OU=Site,OU=Servers,OU=Sys,OU=Organisation,DC=ITProCloud,DC=test&amp;quot;&lt;/p&gt;

&lt;h2 id=&quot;optional-create-a-file-share&quot;&gt;Optional: Create a file share&lt;/h2&gt;

&lt;p&gt;In earlier versions (&lt;1.6.40), you had to provide the deployment script and the AVD agent binaries on a custom file share or blob storage. With WVDAdmin 1.6.40 or newer, this no longer mandatory.
In some cases, where virtual machines don&apos;t have access to the internet to download the AVD agent binaries, you can use a custom file share.
&lt;details&gt;&lt;summary&gt;Read more.&lt;/summary&gt;&lt;br/&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Hint: Alternatively, you can use Azure blob storage to store the script. Make the blob storage read-only and use the URL as rollout script-path. E.g.: &lt;a href=&quot;https://sharedservices01.blob.core.windows.net/wvd&quot;&gt;https://sharedservices01.blob.core.windows.net/wvd&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Create a file share for the configuration script (which adds new session hosts to the domain and install the AVD agent). Give everyone at least read permissions. Set the NTFS permissions to everyone and read. This is necessary while during the first startup, the VM extension tries to execute the script. In this process, the file share is accessed anonymously.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/documentation-009.png&quot; alt=&quot;documentation-009&quot;&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/documentation-010.png&quot; alt=&quot;documentation-010&quot;&gt;&lt;/p&gt;

&lt;p&gt;Place the following files in this share:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://blog.itprocloud.de/assets/files/AutoUpdate/Scripts/ITPC-WVD-Image-Processing.ps1.txt&quot;&gt;ITPC-WVD-Image-Processing.ps1&lt;/a&gt; (rename the download to .ps1)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RWrmXv&quot;&gt;Microsoft.RDInfra.RDAgent.msi&lt;/a&gt; (rename the file)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RWrxrH&quot;&gt;Microsoft.RDInfra.RDAgentBootLoader.msi&lt;/a&gt; (rename the file)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Make sure that you rename the files to fit the list above (without version numbers).&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/documentation-011.png&quot; alt=&quot;documentation-011&quot;&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Important:&lt;/strong&gt; If you are using Windows Server &lt;strong&gt;2019&lt;/strong&gt; as file share, make sure that anonymous file share access is enabled. Create a GPO for the session hosts containing the following configurations:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Security Options:

&lt;ul&gt;
&lt;li&gt;Accounts: Guest Account Status: Enabled&lt;/li&gt;
&lt;li&gt;Network access: Let Everyone permissions apply to anonymous users: Enabled&lt;/li&gt;
&lt;li&gt;Network access: Do not allow anonymous enumeration of SAM accounts and shares: Disabled
&lt;/details&gt;&lt;br/&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&quot;configure-wvdadmin&quot;&gt;Configure WVDAdmin&lt;/h1&gt;

&lt;p&gt;Please start WVDAdmin. Before you load AVD and Azure data, copy the Azure tenant id, service principal id, and service principal key into the welcome tab. Press save and load the data by clicking &amp;quot;Reload all&amp;quot;.&lt;/p&gt;

&lt;p&gt;You are now able to administrate WVD, create images from template VMs and rollout new session hosts.&lt;/p&gt;

&lt;p&gt;The first time you want to roll out new session hosts, you have to enter some information from your Active Directory and file share configuration from above:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/documentation-012.png&quot; alt=&quot;documentation-012&quot;&gt;&lt;/p&gt;

&lt;p&gt;Local Admin and local pw. are the local administrator account credentials which you can enter at this time.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/documentation-013.png&quot; alt=&quot;documentation-013&quot;&gt;&lt;/p&gt;

&lt;h1 id=&quot;build-an-image&quot;&gt;Build an image&lt;/h1&gt;

&lt;p&gt;You can rollout VMs and VM Scale Set with images created by WVDAdmin. These images contain the logic to join the AD domain and WVD.&lt;/p&gt;

&lt;p&gt;You can simple create an image from a template VM. The template VM must part of your AD like a standard client. You have not to sysprep or to normalize this template VM. Use the same template VM for Windows and application updates.&lt;/p&gt;

&lt;p&gt;Following these steps to build your template:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Install a VM in the Azure portal. Select the right OS (like Windows 10 Enterprise for Virtual Desktops)&lt;/li&gt;
&lt;li&gt;Make all Windows updates&lt;/li&gt;
&lt;li&gt;Join the VM to your AD&lt;/li&gt;
&lt;li&gt;Install your application&lt;/li&gt;
&lt;li&gt;Make your customizing (like installing language packages)&lt;/li&gt;
&lt;li&gt;Shutdown the template VM&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;To create the image, open WVDAdmin and&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Navigate to the Azure template VM (Azure -&amp;gt; Virtual Machines -&amp;gt; RG -&amp;gt; VM)&lt;/li&gt;
&lt;li&gt;Right-click -&amp;gt; &amp;quot;Create a template image&amp;quot;&lt;/li&gt;
&lt;li&gt;Select the resource group to store the image&lt;/li&gt;
&lt;li&gt;Press &amp;quot;Capture&amp;quot;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;You can and should reuse the template VM for new updates and applications. After these changes, shut down the template VM and create a new image.&lt;/p&gt;

&lt;h1 id=&quot;tipps-tricks&quot;&gt;Tipps &amp;amp; Tricks&lt;/h1&gt;

&lt;h2 id=&quot;vm-scale-sets&quot;&gt;VM Scale Sets&lt;/h2&gt;

&lt;p&gt;First node: VM Scale Sets cannot autoscale AVD session hosts. Auto-scaling only works for stateless services like a web server. But if you need hundreds of session hosts, then VM Scale Set allows you to work with these numbers efficiently.
&lt;details&gt;&lt;summary&gt;Read more&lt;/summary&gt;&lt;br/&gt;
From version 1.2.5, WVDAdmin support VM Scale Sets. A Scale Set can have several instances, which are the VMs / session hosts. There are some essential things you have to know if you use VM Scale Set with WVDAdmin and AVD itself:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Build a Scale Set with WVDAdmin. Select an image, right-click and select &amp;quot;Create session host from image&amp;quot;. Check &amp;quot;Rollout as VM Scale Set&amp;quot;&lt;/li&gt;
&lt;li&gt;You can use regular disks and ephemeral disks. If you use ephemeral disks, you cannot deallocate the instances of your Scale Set. You have to delete the instances&lt;/li&gt;
&lt;li&gt;Today, you can not use ultra disks&lt;/li&gt;
&lt;li&gt;You can add and remove instances with WVDAdmin or in the Azure Portal. New instances will join the domain and WVD&lt;/li&gt;
&lt;li&gt;A new instance can only join AVD if the session host with the new name doesn&amp;#39;t exist. If you delete instances, the session host entry will also be removed&lt;/li&gt;
&lt;li&gt;You can re-image single instances or all instances of a Scale Set. After that, the instances are &amp;quot;clean&amp;quot; as at the first rollout&lt;/li&gt;
&lt;li&gt;Adding instances or re-imaging assumes that the Scale Set configuration (which is a custom script extension) has a valid AVD token to join new instances to WVD. While AVD provides only one token per host pool and that the token can be expiring, you can update the token with a right-click on the Scale Set and select &amp;quot;Update WVD token&amp;quot;. The max. lifetime of a token is 59 days&lt;/li&gt;
&lt;li&gt;Unfortunately, WVDAdmin cannot change the source image for a VM Scale Set. So if you want to update the image for a host pool, take these steps:

&lt;ul&gt;
&lt;li&gt;Rollout a new Scale Set based on the new image&lt;/li&gt;
&lt;li&gt;Disable new logons for the old session host from the previous Scale Set&lt;/li&gt;
&lt;li&gt;Test the host pool based on the new Scale Set&lt;/li&gt;
&lt;li&gt;If no user logged on to the ancient Scale Set, remove all instances from the Scale Set (this deletes the session hosts in AVD as well)&lt;/li&gt;
&lt;li&gt;Remove the Scale Set
&lt;/details&gt;&lt;br/&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;ephemeral-disks&quot;&gt;Ephemeral  disks&lt;/h2&gt;

&lt;p&gt;Ephemeral disks are awesome. They give you a high performance free of charge. Especially in a AVD multiuser environment where no data a stored permanently on the session hosts, this kind of disk can give you some value add.
&lt;details&gt;&lt;summary&gt;Read more&lt;/summary&gt;&lt;br/&gt;
Ephemeral disks are running on the Azure hypervisor and not stored. This has some advantages:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;There are no storage costs (!)&lt;/li&gt;
&lt;li&gt;A very high data throughput because the disks exist on the hypervisor&lt;/li&gt;
&lt;li&gt;See &lt;a href=&quot;https://twitter.com/michawets&quot;&gt;@MichaWets&lt;/a&gt;   blog post for more information:  &lt;a href=&quot;https://www.cloud-architect.be/2019/07/15/windows-virtual-desktop-running-on-ephemeral-os-disks/&quot;&gt;https://www.cloud-architect.be/2019/07/15/windows-virtual-desktop-running-on-ephemeral-os-disks/&lt;/a&gt; &lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Please note:
- You can not deallocate a VM with this disk type - you have to delete the VM (and roll out a new one instead of starting a &amp;quot;normal&amp;quot; VM)
- Not each VM size is available, and there are limitations of the disk size (image size for rollout) based on the VM size: Max ephemeral disk size for  Standard_D4s_v3  is 64 GByte while a  Standard_D8s_v3 can have up to 128 GByte. See &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/virtual-machines/linux/sizes-general&quot;&gt;https://docs.microsoft.com/en-us/azure/virtual-machines/linux/sizes-general&lt;/a&gt; 
- If the Azure hypervisor fails, your session host will fail as well and can not be re-deployed automatically&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WVDAdmin/documentation-014.png&quot; alt=&quot;documentation-001&quot;&gt;
&lt;/details&gt;&lt;br/&gt;&lt;/p&gt;

&lt;h2 id=&quot;secret-features&quot;&gt;Secret Features&lt;/h2&gt;

&lt;p&gt;WVDAdmin has some features not directly visible but configurable via registry keys. All settings in the registry are in the current user part under HKEY_CURRENT_USER\SOFTWARE\ITProCloud\WVDAdmin. Keep in mind to restart WVDAdmin after changing the registry settings.
&lt;details&gt;&lt;summary&gt;Read more&lt;/summary&gt;&lt;br/&gt;&lt;/p&gt;

&lt;h3 id=&quot;dark-mode&quot;&gt;Dark-mode&lt;/h3&gt;

&lt;p&gt;From version 1.7.33 WVDAdmin can be run in dark-mode. Set the following reg value and restart WVDAdmin: HKEY_CURRENT_USER\Software\ITProCloud\WVDAdmin\DarkMode to 1 (DarkMode is REG_DWORD32)&lt;/p&gt;

&lt;h3 id=&quot;multi-tenant-mode&quot;&gt;Multi-Tenant-Mode&lt;/h3&gt;

&lt;p&gt;From version 1.3.0 WVDAdmin will support a multi-AAD-tenancy mode allowing to switch the Azure AD tenant very easily.
&lt;a href=&quot;../Windows-Virtual-Desktop-Windows-Virtual-Desktop-Administration-for-CSP-and-Consulting-Partners&quot;&gt;Follow this link&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;having-multiple-service-principals-for-a-single-tenant&quot;&gt;Having multiple Service Principals for a single Tenant&lt;/h3&gt;

&lt;p&gt;In the Multi-Tenant-Mode, you can add one service principal per tenant. Sometimes you need more service principals for the same tenant. You can add more service principals for a tenant if you append #1 directly behind the tenant id (or #2, ...).&lt;/p&gt;

&lt;h3 id=&quot;naming-of-the-session-hosts&quot;&gt;Naming of the Session Hosts&lt;/h3&gt;

&lt;p&gt;If you deploy session hosts to a host pool, WVDAdmin counts up the names from the highest available VM. E.g., if you have a session host with the name &amp;quot;WVD-PROD-012&amp;quot; and you rollout new hosts (WVD-PROD-###), the first new hostname is &amp;quot;WVD-PROD-013&amp;quot; - even if you have gaps in the existing numeration. You can force WVDAdmin to fill this gaps (non-existing hosts in the naming schema) if you set the following registry key:
Reg-DWord: &lt;strong&gt;NamingMode&lt;/strong&gt; = &lt;strong&gt;1&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&quot;split-tenant&quot;&gt;Split-Tenant&lt;/h3&gt;

&lt;p&gt;Usually, the AVD tenant and the resources (sessions hosts) are in the same AAD tenant. If you have two Azure AD tenant, you can use WVDAdmin with a second service principal for the session hosts (resource tenant).
&lt;a href=&quot;../Windows-Virtual-Desktop-Admin-for-2-tenant-mode&quot;&gt;Follow this link&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;us-government-cloud&quot;&gt;US-Government Cloud&lt;/h3&gt;

&lt;p&gt;WVDAdmin can be used to deploy AVD in the Azure Government Cloud. You can enable WVDAdmin to work in the US Government Cloud via registry:
Reg-SZ: &lt;strong&gt;Environment&lt;/strong&gt; = &lt;strong&gt;US&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&quot;run-custom-actions-simultaneously&quot;&gt;Run custom actions simultaneously&lt;/h3&gt;

&lt;p&gt;From version 1.6.15, WVDAdmin supports custom scripts to run administrative tasks simultaneously on different session hosts. And that is easy to use and to extend.
&lt;a href=&quot;../Windows-Virtual-Desktop-Admin-CustomScripts&quot;&gt;Follow this link&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;add-a-session-host-automatically-to-an-asg&quot;&gt;Add a session host automatically to an ASG&lt;/h3&gt;

&lt;p&gt;You can add a session host automatically to application security groups (ASG) within the rollout process. To achieve this, add one or more tags to the host pool containing your new session hosts. Name &lt;strong&gt;WVD.Default.ASG.X&lt;/strong&gt; and add the azure resource id of an existing asg. X can be numbers to assign more ASGs. You can copy the id from an ASG from your browser. It looks like this: /subscriptions/&amp;lt;subscription-id&amp;gt;/resourcegroups/&amp;lt;resourcegroup-name&amp;gt;/providers/Microsoft.Network/applicationSecurityGroups/&amp;lt;asg-name&amp;gt;
&lt;img src=&quot;../assets/images/WVDAdmin/asg-001.png&quot; alt=&quot;Tag for ASG&quot;&gt;&lt;/p&gt;

&lt;h3 id=&quot;add-a-session-host-automatically-to-a-loadbalancer-backend-pool&quot;&gt;Add a session host automatically to a Loadbalancer Backend Pool&lt;/h3&gt;

&lt;p&gt;You can add a session host automatically to a loadbalancer backend pool within the rollout process. To achieve this, add one or more tags to the host pool containing your new session hosts. Name &lt;strong&gt;WVD.Default.LBPool.X&lt;/strong&gt; and add the azure resource id of an existing loadbalancer backend pool. X can be numbers to assign more ASGs. You can copy the id from a pool from your browser. It looks like this: /subscriptions/&amp;lt;subscription-id&amp;gt;/resourcegroups/&amp;lt;resourcegroup-name&amp;gt;/providers/Microsoft.Network/loadBalancers/&amp;lt;loadbalancer-name&amp;gt;/backendAddressPools/&amp;lt;pool-name&amp;gt;
Keep in mind to use availability sets for each rollout to use this feature.&lt;/p&gt;

&lt;h3 id=&quot;rollout-session-hosts-with-azure-disk-encryption-ade&quot;&gt;Rollout session hosts with Azure Disk Encryption (ADE)&lt;/h3&gt;

&lt;p&gt;Set two tags to the host pool to use it: &amp;quot;WVD.Default.KeyVault.Id&amp;quot; with the resource id of the KeyVault, &amp;quot;WVD.Default.KeyVault.KeyUri&amp;quot; with the URI (including the version) of the prepared key to wrap the secret.&lt;/p&gt;

&lt;h3 id=&quot;2nd-network-interface&quot;&gt;2nd Network interface&lt;/h3&gt;

&lt;p&gt;Set a tag to the host pool with the name &amp;quot;WVD.Default.VM.2ndNic&amp;quot; and with the subnet resource id as value
&lt;/details&gt;&lt;br/&gt;&lt;/p&gt;

&lt;h1 id=&quot;troubleshooting&quot;&gt;Troubleshooting&lt;/h1&gt;

&lt;h2 id=&quot;create-an-image&quot;&gt;Create an Image&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;The image is not created. An error message occurs:&lt;/li&gt;
&lt;li&gt;Check if your template VM part of the AD&lt;/li&gt;
&lt;li&gt;If your file server Windows Server 2019, read above&lt;/li&gt;
&lt;li&gt;Check if you have set the NTFS and share permission correctly&lt;/li&gt;
&lt;li&gt;Azure portal: Go to the temp VM (next to the template VM) and check the extension installation state. There should be an error message like script not found, access denied, etc.&lt;/li&gt;
&lt;li&gt;Have you renamed the RD agent and bootloader?&lt;/li&gt;
&lt;li&gt;Is the script saved correctly: ITPC-WVD-Image-Processing.ps1, not ITPC-WVD-Image-Processing.ps1.txt&lt;/li&gt;
&lt;li&gt;Don&amp;#39;t forget to delete the temp VM and temp disk to avoid costs&lt;/li&gt;
&lt;li&gt;Make sure that your template VM uses managed disk&lt;/li&gt;
&lt;li&gt;The script generates additional log files in %WinDir%\System32\LogFiles&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Windows 7&lt;/em&gt;: Make sure to install PowerShell 5.1 and all Windows updates (including the optional updates without the language packages) to the template VM and restart the VM to take effect: &lt;a href=&quot;https://www.microsoft.com/en-us/download/details.aspx?id=54616&quot;&gt;https://www.microsoft.com/en-us/download/details.aspx?id=54616&lt;/a&gt; Makes sure that you use the newest script file from 09/2020: &lt;a href=&quot;https://blog.itprocloud.de/assets/files/AutoUpdate/Scripts/ITPC-WVD-Image-Processing.ps1.txt&quot;&gt;ITPC-WVD-Image-Processing.ps1&lt;/a&gt;&lt;br&gt;&lt;/li&gt;
&lt;li&gt;NEW: An endless loop of &amp;quot;Waiting for the temporary vm (power off)&amp;quot; : Update to the newest PowerShell script for generalizing: &lt;a href=&quot;https://blog.itprocloud.de/assets/files/AutoUpdate/Scripts/ITPC-WVD-Image-Processing.ps1.txt&quot;&gt;ITPC-WVD-Image-Processing.ps1&lt;/a&gt;&lt;br&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;others&quot;&gt;Others&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;You have created a host pool, an app group, and assigned a user to the app group, but the user cannot see the apps/desktop.

&lt;ul&gt;
&lt;li&gt;For AVD ARM: Don&amp;#39;t forget to create a workspace and link the app group in the workspace. The workspace is mandatory to show the users&amp;#39; resources.&lt;/li&gt;
&lt;li&gt;For the HTML5 web site: Check the correct web address:

&lt;ul&gt;
&lt;li&gt;ARM/Spring: &lt;a href=&quot;https://aka.ms/wvdarmweb&quot;&gt;https://aka.ms/wvdarmweb&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Classic/Fall: &lt;a href=&quot;http://aka.ms/wvdweb&quot;&gt;http://aka.ms/wvdweb&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&quot;../assets/files/WVDAdmin.msi&quot;&gt;&lt;img src=&quot;../assets/icons/download.png&quot; alt=&quot;Download&quot;&gt; &lt;strong&gt;Download the latest release from 04/01/2025&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Tue, 01 Apr 2025 00:00:00 +0200</pubDate>
        <link>https://blog.itprocloud.de/Windows-Virtual-Desktop-Admin/</link>
        <guid isPermaLink="true">https://blog.itprocloud.de/Windows-Virtual-Desktop-Admin/</guid>
        
        
        <category>Windows Virtual Desktop</category>
        
        <category>Azure Virtual Desktop</category>
        
      </item>
    
      <item>
        <title>Deployment of an Azure Virtual Desktop image failed after updating to Windows 24H2 with a blue screen 0xc000000f</title>
        <description>&lt;p&gt;Several users reported a failure during the rollout of images in Azure Virtual Desktop in the last months. The error pattern was always the same: The virtual machine was built, and the next step failed while the VM was no longer running.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/bs-0xc000000f-02.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;We figured out that the VM installation resulted in a blue screen with the error message 0xc000000f, Windows shut down internally, and the VM was stopped in Azure. That was reproducible and caused by the image itself. The image was created by capturing a Golden Master with &lt;a href=&quot;https://github.com/MarcelMeurer/WVD-Hydra&quot;&gt;Hydra for Azure Virtual Desktop&lt;/a&gt; or &lt;a href=&quot;https://blog.itprocloud.de/Windows-Virtual-Desktop-Admin/&quot;&gt;WVDAdmin&lt;/a&gt; (which can image an existing VM without destroying it).&lt;/p&gt;

&lt;p&gt;Interesting: Older images from the same Golden Masters are working. The only difference between them is that the Golden Master was updated to Windows 11 24H2.&lt;/p&gt;

&lt;p&gt;So, we inspected the Golden Master and started the imaging process step by step. After a while, we figured out that during the Sysprep process, Windows started to encrypt the C: drive. During the encryption, Sysprep finished and shut down the VM, and the imaging process continued. Unfortunately, the captured image is half encrypted and, for that reason, not deployable as a new VM/host.&lt;/p&gt;

&lt;p&gt;We never figured out why this happened after upgrading to 24H2, and that also doesn&amp;#39;t happen if your Golden Master was built on 24H2 initially.&lt;/p&gt;

&lt;p&gt;Solution: The solution is more of a workaround. But if we disable the Bit Locker service on the Golden Master, the Sysprep process will not encrypt the C: drive, and the image will be deployable.&lt;/p&gt;

&lt;p&gt;The upcoming version of Hydra and WVDAdmin will disable the Bit Locker service temporarily during the imaging process.&lt;/p&gt;
</description>
        <pubDate>Mon, 17 Mar 2025 00:00:00 +0100</pubDate>
        <link>https://blog.itprocloud.de/Rollout-Image-BlueScreen-0xc000000f-24h2/</link>
        <guid isPermaLink="true">https://blog.itprocloud.de/Rollout-Image-BlueScreen-0xc000000f-24h2/</guid>
        
        
        <category>Windows Virtual Desktop</category>
        
        <category>Azure Virtual Desktop</category>
        
        <category>Entra</category>
        
      </item>
    
      <item>
        <title>Using FSLogix file shares with Azure AD cloud identities in Azure Virtual Desktop - cloud-only, AVD</title>
        <description>&lt;p&gt;With AAD-Kerberos, you can use AAD-only joined session hosts with FSLogix. This is a great approach to working more cloud-native. With AAD-Kerberos, the session hosts don&amp;#39;t need to have network line-of-sight to the domain controller. &lt;/p&gt;

&lt;p&gt;However, the user identities must still be hybrid / synchronized from a legacy AD right now. And that prevents having AAD-only users in a multi-user pool in AVD where a profile is mostly mandatory.&lt;/p&gt;

&lt;h2 id=&quot;update-2023-03-02&quot;&gt;Update 2023-03-02&lt;/h2&gt;

&lt;p&gt;There was an issue in the script/parameter for cmdkey. The parameter we need is /add not /generic&lt;/p&gt;

&lt;h2 id=&quot;update-2023-02-15&quot;&gt;Update 2023-02-15&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;Change of the script to work with Windows 11 22H2&lt;/strong&gt;
Windows 11 22H2 removes the cmdkey entry if the host is deallocated and started again. The additional registry key prevents this behavior.&lt;/p&gt;

&lt;h2 id=&quot;update-2024-12-05&quot;&gt;Update 2024-12-05&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;Change of the script to include credentials in the profile&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;update-2025-03-13&quot;&gt;Update 2025-03-13&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;Fix of the script to include credentials in the profile&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;workaround&quot;&gt;Workaround&lt;/h2&gt;

&lt;p&gt;I found a nice workaround to do the same with cloud-only users in Azure AD - including the use of FSLogix file shares.&lt;/p&gt;

&lt;p&gt;Today, an Azure file share cannot be configured to use the AAD like an AD to set NTFS permissions. This is necessary to give the users the right permissions to create a profile folder on the share and have full access only to their own created files (the profile disk). Users should never have access to the profile disks of other users - to prevent data theft or to modify other users&amp;#39; data).&lt;/p&gt;

&lt;p&gt;But how to handle this? For this workaround, I use a technic I have often used in the past to cover similar challenges (like &lt;a href=&quot;https://blog.itprocloud.de/How-to-use-MSIX-AppAttach-without-having-computer-accounts-synced-for-Azure-Virtual-Desktop-AD-synced-Azure-Files/&quot;&gt;this post&lt;/a&gt;). In Windows, you can configure on a resource level what credential should be used - and that on a per-user level. This also works for the system account and, therefore, also for services. So, we are able to &amp;quot;teach&amp;quot; the system account to use specific credentials to access an Azure storage account.&lt;/p&gt;

&lt;p&gt;In our case, we need credentials to have full access to an Azure file share. And there are credentials to do that: The storage account credentials. Each storage account has credentials that can be used to have full access. You can grab the credentials from the &amp;quot;Access Key&amp;quot; menu in the storage account:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/AAD-Only-FSLogix-005.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;Collect the right values:&lt;/p&gt;

&lt;table&gt;&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Type&lt;/th&gt;
&lt;th&gt;Value&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;User name:&lt;/td&gt;
&lt;td&gt;localhost\&lt;storageAccountName\&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Secret:&lt;/td&gt;
&lt;td&gt;&amp;lt;Key&amp;gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;StorageAccountFqdn:&lt;/td&gt;
&lt;td&gt;&amp;lt;storageAccountName&amp;gt;.file.core.net (the files endpoint)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;

&lt;p&gt;In my example, the user name is &amp;quot;localhost\avdaadstorage&amp;quot; and &amp;lt;StorageAccountFqdn&amp;gt; is &amp;quot;avdaadstorage.file.core.windows.net&amp;quot;&lt;/p&gt;

&lt;p&gt;To &amp;quot;teach&amp;quot; the system account to use these credentials, we have to run the following command in the context of the system account:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-&quot; data-lang=&quot;&quot;&gt;cmdkey.exe /add:&amp;lt;StorageAccountFqdn&amp;gt; /user:localhost\&amp;lt;StorageAccountName&amp;gt; /pass:&amp;lt;Key&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Example:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-&quot; data-lang=&quot;&quot;&gt;cmdkey.exe /add:avdaadstorage.file.core.windows.net /user:localhost\avdaadstorage /pass:xxxxxxxxxxxxxxxx
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After running the command on a host/VM, any access in the context of the system account to the storage runs with the configured credentials - to every share!&lt;/p&gt;

&lt;p&gt;Great, our system can now access the shares on the storage account and has full permission. &lt;/p&gt;

&lt;h3 id=&quot;window-11-22h2-and-credential-guard-with-uefi-lock&quot;&gt;Window 11 22H2 and Credential Guard with UEFI lock&lt;/h3&gt;

&lt;p&gt;To prevent that Windows 11 22H2 removes the cmdkey entry if the host is deallocated and started again. The additional registry key is needed:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-&quot; data-lang=&quot;&quot;&gt;New-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Control\Lsa&quot; -Name &quot;LsaCfgFlags&quot; -Value 0 -force  # Only needed for Windows 11 22H2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Remember that this disables &lt;a href=&quot;https://learn.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard-manage#enable-virtualization-based-security-and-windows-defender-credential-guard&quot;&gt;Windows Defender Credential Guard&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;credential-manager&quot;&gt;Credential manager&lt;/h3&gt;

&lt;p&gt;If you save credentials to the credential manager, those credentials are not included in the profile. This can be changed by setting the following registry key and value&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-&quot; data-lang=&quot;&quot;&gt;New-ItemProperty -Path &quot;HKLM:\Software\Policies\Microsoft\AzureADAccount&quot; -Name &quot;LoadCredKeyFromProfile&quot; -Value 1 -force
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;configuring-fslogix&quot;&gt;Configuring FSLogix&lt;/h2&gt;

&lt;p&gt;Next step: Configure FSLogix to use the system account. Normally, FSLogix will access the share to store and read profiles in the user context. That is normally fine if users are able to authenticate with their own identity. In our case, we want to use the system account. The following reg-key configures FSLogix to use the system account:&lt;/p&gt;

&lt;table&gt;&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Type&lt;/th&gt;
&lt;th&gt;Value&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Path:&lt;/td&gt;
&lt;td&gt;HKLM:\SOFTWARE\FSLogix\Profiles&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Name:&lt;/td&gt;
&lt;td&gt;AccessNetworkAsComputerObject&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Type:&lt;/td&gt;
&lt;td&gt;DWord&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Value:&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;

&lt;p&gt;This value can be set via registry or PowerShell:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-&quot; data-lang=&quot;&quot;&gt;New-Item -Path &quot;HKLM:\SOFTWARE&quot; -Name &quot;FSLogix&quot; -ErrorAction Ignore
New-Item -Path &quot;HKLM:\SOFTWARE\FSLogix&quot; -Name &quot;Profiles&quot; -ErrorAction Ignore
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;AccessNetworkAsComputerObject&quot; -Value 1 -force
New-ItemProperty -Path &quot;HKLM:\Software\Policies\Microsoft\AzureADAccount&quot; -Name &quot;LoadCredKeyFromProfile&quot; -Value 1 -force # Include credentials in the profile
New-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Control\Lsa&quot; -Name &quot;LsaCfgFlags&quot; -Value 0 -force  # Only needed for Windows 11 22H2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If not already done, configure the file share:
- Create a share on your storage account (e.g., profiles)
- Configure FSLogix to use the share on each host:&lt;/p&gt;

&lt;table&gt;&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Type&lt;/th&gt;
&lt;th&gt;Value&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Path:&lt;/td&gt;
&lt;td&gt;HKLM:\SOFTWARE\FSLogix\Profiles&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Name:&lt;/td&gt;
&lt;td&gt;VHDLocations&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Type:&lt;/td&gt;
&lt;td&gt;Reg_SZ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Value:&lt;/td&gt;
&lt;td&gt;\\&lt;StorageAccountFqdn\&gt;\&amp;lt;ProfileShareName&amp;gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;

&lt;p&gt;And enable FSLogix profile service:&lt;/p&gt;

&lt;table&gt;&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Type&lt;/th&gt;
&lt;th&gt;Value&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Path:&lt;/td&gt;
&lt;td&gt;HKLM:\SOFTWARE\FSLogix\Profiles&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Name:&lt;/td&gt;
&lt;td&gt;Enabled&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Type:&lt;/td&gt;
&lt;td&gt;DWord&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Value:&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;

&lt;p&gt;After that, users can log in to the hosts, and the profile is stored on the file share on the storage account:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/AAD-Only-FSLogix-000.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;h2 id=&quot;security&quot;&gt;Security&lt;/h2&gt;

&lt;p&gt;How secure is that? 
- Users cannot access their own or other profiles by entering the path to the share while they don&amp;#39;t have the storage account credentials. 
- Users can also not run programs in the system context (if they are not local admins on the host - what I expect).
- Every local administrator of a host can run processes in the system context: So the local admin permissions/role must be secured to prevent admins from accessing the profile storage indirectly or reading the storage account credentials.
- Azure Administrator with the permission Microsoft.Compute/virtualMachines/runCommand/action can send scripts running in the system context to a host/VM (like a contributor). That is comparable to local administrator permission.
- The system has permission to access all shares on the storage account with the credentials. Not only the profile share. It makes sense to have a separate share for the profiles.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Summary:&lt;/strong&gt; Users with non-admin permissions can not access other users&amp;#39; profiles. Local admins are able to do this, but local admins are able to compromise users in other ways. So local admin privileges &lt;strong&gt;should be considered carefully&lt;/strong&gt;. Same for privileged access in Azure.&lt;/p&gt;

&lt;h2 id=&quot;do-the-full-configuration-with-a-script&quot;&gt;Do the full configuration with a script&lt;/h2&gt;

&lt;p&gt;Let me share a script you can use to do the full configuration with a script. In the script, I also set some other basic configurations I mostly use for FSLogix. Keep in mind that the user name is part of the path and profile disk name. If you rename the display name of a user, the user will get a new profile.&lt;/p&gt;

&lt;p&gt;The script must be executed directly after the rollout of a new host in the system context. It&amp;#39;s not possible to do that on the Master VM while the credential store is reset during sysprep. To run the script in the system context, use PSEXEC to open PowerShell in the system context (psexec /s powershell.exe).&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;WARNING:&lt;/strong&gt; The script contains a secret. Delete the script from the host&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-&quot; data-lang=&quot;&quot;&gt;write-host &quot;Configuring FSLogix&quot;
$fileServer=&quot;avdaadstorage.file.core.windows.net&quot;
$profileShare=&quot;\\$($fileServer)\profiles&quot;

$user=&quot;localhost\avdaadstorage&quot;
$secret=&quot;###################&quot;

New-Item -Path &quot;HKLM:\SOFTWARE&quot; -Name &quot;FSLogix&quot; -ErrorAction Ignore
New-Item -Path &quot;HKLM:\SOFTWARE\FSLogix&quot; -Name &quot;Profiles&quot; -ErrorAction Ignore
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;Enabled&quot; -Value 1 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;VHDLocations&quot; -Value $profileShare -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;ConcurrentUserSessions&quot; -Value 1 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;DeleteLocalProfileWhenVHDShouldApply&quot; -Value 1 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;FlipFlopProfileDirectoryName&quot; -Value 1 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;IsDynamic&quot; -Value 1 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;KeepLocalDir&quot; -Value 0 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;ProfileType&quot; -Value 0 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;SizeInMBs&quot; -Value 40000 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;VolumeType&quot; -Value &quot;VHDX&quot; -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;AccessNetworkAsComputerObject&quot; -Value 1 -force

# Include credentials in the profile
New-Item -Path &quot;HKLM:\Software\Policies\Microsoft&quot; -Name &quot;AzureADAccount&quot; -ErrorAction Ignore
New-ItemProperty -Path &quot;HKLM:\Software\Policies\Microsoft\AzureADAccount&quot; -Name &quot;LoadCredKeyFromProfile&quot; -Value 1 -force

# Store credentials to access the storage account
cmdkey.exe /add:$fileServer /user:$($user) /pass:$($secret)
# Disable Windows Defender Credential Guard (only needed for Windows 11 22H2)
New-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Control\Lsa&quot; -Name &quot;LsaCfgFlags&quot; -Value 0 -force

write-host &quot;The script has finished.&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;use-hydra-to-run-the-script-on-demand-or-automatically-after-each-rollout&quot;&gt;Use Hydra to run the script on-demand or automatically after each rollout&lt;/h2&gt;

&lt;p&gt;You can use &lt;a href=&quot;https://blog.itprocloud.de/Hydra-for-Azure-Virtual-Desktop-AVD-is-available-in-the-Azure-Marketplace/&quot;&gt;Hydra for Azure Virtual Desktop&lt;/a&gt; to apply the script automatically after rolling out a new host. &lt;/p&gt;

&lt;p&gt;Open the host pool configuration in Hydra -&amp;gt; Base and configure the service account:
- Service account name: localhost\avdaadstorage
- Service account password: &amp;lt;key of the storage account&amp;gt;
- Save&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/AAD-Only-FSLogix-002.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;Scripts and Collections -&amp;gt; Scripts
- Duplicate an existing script to have a new one
- Check &amp;quot;Service Account&amp;quot;
- Give it a good name (e.g., &amp;quot;FSLogix and Cloud Accounts - Hydra integrated&amp;quot;)
- Copy the following script into the code field
- Save&lt;/p&gt;

&lt;p&gt;Script:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-&quot; data-lang=&quot;&quot;&gt;# Check, if service account available
if ($global:Hydra_ServiceAccount_PSC -eq $null) {
    throw &quot;Failed: Service account missing - The script needs a configured service account. You can configure the service account (having full access to the FSLogix profile share on the host pool configuration.&quot;
}

LogWriter(&quot;Configuring FSLogix&quot;)
$fileServer=&quot;$($($global:Hydra_ServiceAccount_PSC.UserName).Split(&apos;\&apos;)[1]).file.core.windows.net&quot;
$profileShare=&quot;\\$($fileServer)\profiles&quot;

New-Item -Path &quot;HKLM:\SOFTWARE&quot; -Name &quot;FSLogix&quot; -ErrorAction Ignore
New-Item -Path &quot;HKLM:\SOFTWARE\FSLogix&quot; -Name &quot;Profiles&quot; -ErrorAction Ignore
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;Enabled&quot; -Value 1 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;VHDLocations&quot; -Value $profileShare -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;ConcurrentUserSessions&quot; -Value 1 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;DeleteLocalProfileWhenVHDShouldApply&quot; -Value 1 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;FlipFlopProfileDirectoryName&quot; -Value 1 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;IsDynamic&quot; -Value 1 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;KeepLocalDir&quot; -Value 0 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;ProfileType&quot; -Value 0 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;SizeInMBs&quot; -Value 40000 -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;VolumeType&quot; -Value &quot;VHDX&quot; -force
New-ItemProperty -Path &quot;HKLM:\SOFTWARE\FSLogix\Profiles&quot; -Name &quot;AccessNetworkAsComputerObject&quot; -Value 1 -force

# Include credentials in the profile
New-Item -Path &quot;HKLM:\Software\Policies\Microsoft&quot; -Name &quot;AzureADAccount&quot; -ErrorAction Ignore
New-ItemProperty -Path &quot;HKLM:\Software\Policies\Microsoft\AzureADAccount&quot; -Name &quot;LoadCredKeyFromProfile&quot; -Value 1 -force

LogWriter(&quot;Setting credentials to access the storage account of the system&quot;)
cmdkey.exe /add:$fileServer /user:$($global:Hydra_ServiceAccount_PSC.UserName) /pass:([System.Net.NetworkCredential]::new(&quot;&quot;,$global:Hydra_ServiceAccount_PSC.password).Password)
LogWriter(&quot;Disable Windows Defender Credential Guard (only needed for Windows 11 22H2)&quot;)
New-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Control\Lsa&quot; -Name &quot;LsaCfgFlags&quot; -Value 0 -force

OutputWriter(&quot;The script has finished.&quot;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;../assets/images/AAD-Only-FSLogix-001.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;After that, you can trigger the script on a host or let it run automatically after each deployment:
- Open the host pool configuration in Hydra -&amp;gt; New Session Host Rollout
- Configure the rollout parameter
- Select the script in &amp;quot;Run script or script collection after deployment&amp;quot;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/AAD-Only-FSLogix-003.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;After that a new rollout looks like this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/AAD-Only-FSLogix-004.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;h2 id=&quot;others&quot;&gt;Others&lt;/h2&gt;

&lt;p&gt;And yes, there are other options to run the script in the system context automatically. Please ensure that the password/secret &lt;strong&gt;is not stored on the host&amp;#39;s disk&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Hint:&lt;/strong&gt; You can create another share for MSIX App-Attach packages. The system account also has permission to load the packages.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Note: It&amp;#39;s a nice workaround to bridge the time until there is a native solution in Azure. Please use it at your own risk.&lt;/strong&gt;&lt;/p&gt;
</description>
        <pubDate>Thu, 13 Mar 2025 00:00:00 +0100</pubDate>
        <link>https://blog.itprocloud.de/Using-FSLogix-file-shares-with-Azure-AD-cloud-identities-in-Azure-Virtual-Desktop-AVD/</link>
        <guid isPermaLink="true">https://blog.itprocloud.de/Using-FSLogix-file-shares-with-Azure-AD-cloud-identities-in-Azure-Virtual-Desktop-AVD/</guid>
        
        
        <category>Windows Virtual Desktop</category>
        
        <category>Azure Virtual Desktop</category>
        
      </item>
    
      <item>
        <title>Debugging Azure Virtual Desktop errors/issues/network latency and bandwidth with an interactive Workbook</title>
        <description>&lt;p&gt;Correctly configured, Azure Virtual Desktop sends diagnostic data to a log analytics workspace (Azure Monitor). There are several logs containing data about the events in the backend:&lt;/p&gt;

&lt;table&gt;&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Log Type&lt;/th&gt;
&lt;th&gt;Note&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;WVDAgentHealthStatus&lt;/td&gt;
&lt;td&gt;Details about the session hosts&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WVDConnections&lt;/td&gt;
&lt;td&gt;All about connections from a user to a session host&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WVDErrors&lt;/td&gt;
&lt;td&gt;Error message from different sources (client, RDGateway, Loadbalancer, ...)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WVDFeeds&lt;/td&gt;
&lt;td&gt;Log about clients downloading information about the AVD resources&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WVDHostRegistrations&lt;/td&gt;
&lt;td&gt;Logs if a host tries to register to a host pool&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WVDManagement&lt;/td&gt;
&lt;td&gt;Log about administrative tasks&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WVDCheckpoints&lt;/td&gt;
&lt;td&gt;Detailed information related to logins, errors, ...&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;WVDConnectionNetworkData&lt;/td&gt;
&lt;td&gt;Network information (bandwidth and RTT)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;

&lt;p&gt;To get the logs, configure at least the host pool to send log information to a log analytics workspace. You can do this on a host pool level -&amp;gt; Diagnostic settings -&amp;gt; Add diagnostic settings -&amp;gt; Select all Logs and target a log analytics workspace.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/Avd-Error-Monitoring-01.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;Alternatively, you can use &lt;a href=&quot;https://blog.itprocloud.de/Windows-Virtual-Desktop-Admin/&quot;&gt;WVDAdmin&lt;/a&gt; to do that (use version 1.7.25 or higher):&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/Avd-Error-Monitoring-02.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;It will take a while before you can see the first data. The data can be queried with the KUSTO language or analyzed with custom workbooks. I prepared a workbook to dig into the data. Most visualizations are interactive. So you can drill down by selecting users, networks, agent versions, and more.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/AVD-Monitoring-Workbook-Errors.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/MonitorSessionHosts-12.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/Avd-Error-Monitoring-13.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/Avd-Error-Monitoring-14.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;You can install the workbook directly as a template into your subscription: &lt;a href=&quot;https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fblog.itprocloud.de%2Fassets%2Ffiles%2FAzureDeployments%2FWorkbook-AVD-Error-Logging.json&quot;&gt;Install the workbook&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;After a while, the workbook is visible as a new template in: &lt;strong&gt;Log Analytics -&amp;gt; Workbooks -&amp;gt; Azure Virtual Desktop -&amp;gt; AVD - Deep-Insights&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;You can select the time frame and host pool from the drop-down list. The other drop-down lists are optional. Please ensure that you have included the essential errors from the error selector. Remember that not all errors are making issues (e.g., &amp;quot;&lt;em&gt;ConnectionFailedClientDisconnected&lt;/em&gt;&amp;quot; occurs if a session goes in the disconnected mode while the users close its notebook).&lt;/p&gt;

&lt;p&gt;Please let me know if you have ideas to extend the workbook.&lt;/p&gt;

&lt;table&gt;&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Version&lt;/th&gt;
&lt;th&gt;Date&lt;/th&gt;
&lt;th&gt;Note&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;1.1&lt;/td&gt;
&lt;td&gt;01/28/2022&lt;/td&gt;
&lt;td&gt;Initial&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.2&lt;/td&gt;
&lt;td&gt;02/17/2022&lt;/td&gt;
&lt;td&gt;Include RTT and bandwidth (right now, host pool must be in the validation environment and diagnostic data must include &lt;strong&gt;NetworkData&lt;/strong&gt;); Renaming of the workbook&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.3&lt;/td&gt;
&lt;td&gt;03/16/2022&lt;/td&gt;
&lt;td&gt;Include Logon timing (GPO, FSLogix, Authentication, etc.)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.4&lt;/td&gt;
&lt;td&gt;04/14/2022&lt;/td&gt;
&lt;td&gt;In Session Bandwidths &amp;amp; Latencies: The connection type is shown if RDP Short Path is used (Public, Private). See: &lt;a href=&quot;https://docs.microsoft.com/en-us/azure/virtual-desktop/shortpath-public&quot;&gt;https://docs.microsoft.com/en-us/azure/virtual-desktop/shortpath-public&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.5&lt;/td&gt;
&lt;td&gt;05/03/2022&lt;/td&gt;
&lt;td&gt;New visualization: Logon timing per day and category over the time&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.6&lt;/td&gt;
&lt;td&gt;10/11/2022&lt;/td&gt;
&lt;td&gt;New visualization: Connections over time, unhealthy session hosts, graphic performance&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.7&lt;/td&gt;
&lt;td&gt;11/03/2022&lt;/td&gt;
&lt;td&gt;Optimization for charts to show data over a large time frame&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.8&lt;/td&gt;
&lt;td&gt;11/14/2022&lt;/td&gt;
&lt;td&gt;A new tab &amp;quot;Resources&amp;quot;, to show orphan session hosts; Fix: Number of active and inactive sessions - timeselector was not correct&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.9&lt;/td&gt;
&lt;td&gt;11/18/2022&lt;/td&gt;
&lt;td&gt;A new tab &amp;quot;Resources&amp;quot;, to show orphan VMs (where the session host object is missing)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.0&lt;/td&gt;
&lt;td&gt;12/01/2022&lt;/td&gt;
&lt;td&gt;Changed the description for the estimated available bandwidth&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.1&lt;/td&gt;
&lt;td&gt;12/09/2022&lt;/td&gt;
&lt;td&gt;Added orphan disks and orphan nics to the &amp;quot;Resources&amp;quot; tab (note: All orphand devices will also shown and could be removed in Hydra for Azure Virtual Desktop, version 1.0.1.84 (comming soon))&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.2&lt;/td&gt;
&lt;td&gt;02/02/2023&lt;/td&gt;
&lt;td&gt;Added &amp;quot;Water Markings&amp;quot; to query session information by the feature &lt;a href=&quot;https://learn.microsoft.com/en-us/azure/virtual-desktop/watermarking&quot;&gt;WaterMarking&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.3&lt;/td&gt;
&lt;td&gt;02/20/2023&lt;/td&gt;
&lt;td&gt;Added &amp;quot;Unresponding AVD Agents&amp;quot; in the tab &amp;quot;Resources&amp;quot; to identify running VM with a non responding AVD agent&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.4&lt;/td&gt;
&lt;td&gt;02/21/2023&lt;/td&gt;
&lt;td&gt;Added new tab &amp;quot;FSLogix&amp;quot; to show the size, usage and free space of the FSLogix profiles&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.5&lt;/td&gt;
&lt;td&gt;03/08/2023&lt;/td&gt;
&lt;td&gt;Fix in the time selector; allow to selecte multiple host pools; show active sessions with user name and started desktop/remote app&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.6&lt;/td&gt;
&lt;td&gt;03/31/2023&lt;/td&gt;
&lt;td&gt;Add: Show office container size and usage (ODFC) in the FSLogix tab (additional to the profile container)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.7&lt;/td&gt;
&lt;td&gt;07/01/2023&lt;/td&gt;
&lt;td&gt;Fix/Workaround: VHDFreeSpace is stored as text in MByte and not in GByte if the value is less then 1 GByte&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2.8&lt;/td&gt;
&lt;td&gt;10/13/2023&lt;/td&gt;
&lt;td&gt;Add: Show the last heart beat time in the Orphan session hosts view and warns, if the heart beat is longer then 90 days ago&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;3.0&lt;/td&gt;
&lt;td&gt;06/24/2024&lt;/td&gt;
&lt;td&gt;Fix: Orphan resources are now including temporary orphan hosts&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;3.1&lt;/td&gt;
&lt;td&gt;10/24/2024&lt;/td&gt;
&lt;td&gt;Add: Show &amp;quot;TURN&amp;quot; in session bandwidth and latency (if session was connected via TURN)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;3.2&lt;/td&gt;
&lt;td&gt;11/29/2024&lt;/td&gt;
&lt;td&gt;Add: Show the country and city of the connections (based on the client internet IP)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;

&lt;p&gt;&lt;a href=&quot;https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fblog.itprocloud.de%2Fassets%2Ffiles%2FAzureDeployments%2FWorkbook-AVD-Error-Logging.json&quot;&gt;&lt;img src=&quot;https://aka.ms/deploytoazurebutton&quot; alt=&quot;Deploy to Azure&quot;&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please click twice on create to accept the Microsoft Agreement of terms - Workbooks don&amp;#39;t generate costs.&lt;/p&gt;
</description>
        <pubDate>Mon, 02 Dec 2024 00:00:00 +0100</pubDate>
        <link>https://blog.itprocloud.de/AVD-Azure-Virtual-Desktop-Error-Drill-Down-Workbook/</link>
        <guid isPermaLink="true">https://blog.itprocloud.de/AVD-Azure-Virtual-Desktop-Error-Drill-Down-Workbook/</guid>
        
        
        <category>Windows Virtual Desktop</category>
        
        <category>Azure Virtual Desktop</category>
        
        <category>Azure Monitor</category>
        
        <category>Log Analytics</category>
        
      </item>
    
      <item>
        <title>Entra Dynamic Device Groups for Azure Virtual Desktop - Host Pools, Resource Groups and Subscriptions</title>
        <description>&lt;p&gt;I was searching for an option to group all AVD hosts (Entra and hybrid joined) of a pool in a dynamic device group. Unfortunately, I didn&amp;#39;t find a perfect solution that works without modifying the device objects through the Graph API (or AD for hybrid joined devices (extensionAttributes)). If one of the readers knows a good solution for this, please share it.&lt;/p&gt;

&lt;p&gt;Therefore, I checked the different properties of a device in Entra to find one I can use to create a dynamic device group. I prefer having a naming schema reflecting the specific host pools. AVD-DESIGN-001 and up counting would be a good match to identify all hosts of my pool &amp;quot;Design&amp;quot;. The rule is simple:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/Entra-Dynamic-Device-Group-02.png&quot; alt=&quot;&quot;&gt;
&lt;code&gt;(device.displayName -startsWith &amp;quot;AVD-DESIGN-&amp;quot;)&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;After a while, the group contains all hosts/VMs matching this schema. The query can also be made more complex by including/excluding specific Windows types (multi-user or single-user OS).&lt;/p&gt;

&lt;p&gt;I also found another interesting property in the devices for Entra joined VMs (not for hybrid joined):&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/Entra-Dynamic-Device-Group-03.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;The property &amp;quot;physicalIds&amp;quot; contains a list of strings. One string reflects the Azure resource ID of the virtual machine (the session hosts the linked VM):&lt;/p&gt;

&lt;p&gt;The resource ID in Azure has a default schema that reflects the subscription ID, resource group name, provider, and the name of the resource. Some resources also have subtypes, which is not important for our VMs. The resource ID is always in the device property and is written with the join of the device to Entra.&lt;/p&gt;

&lt;p&gt;We can now build dynamic device groups based on the resource group or subscription. If you are using different resource groups for your host pools, you can also use this method to group the VMs — independent from the naming concept. Or you can group all the VMs of your AVD subscription and combine them to validate the display names. That makes your dynamic group more resilient and excludes VMs from other subscriptions.&lt;/p&gt;

&lt;p&gt;Here is an example of grouping all VMs in the resource group &amp;quot;WVD.Design2&amp;quot; in the given subscription:
&lt;img src=&quot;../assets/images/Entra-Dynamic-Device-Group-04.png&quot; alt=&quot;&quot;&gt;
&lt;code&gt;(device.devicePhysicalIds -any (_ -startsWith&amp;quot;[AzureResourceId]:/subscriptions/dcdce2ee-****-****-****-************/resourceGroups/wvd.Design2/providers/Microsoft.Compute/virtualMachines/&amp;quot;))&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;After a while, all VMs/hosts are members of the group.&lt;/p&gt;

&lt;p&gt;Even if that doesn&amp;#39;t solve my challenge very well, it&amp;#39;s a nice workaround or at least increased my insights.&lt;/p&gt;
</description>
        <pubDate>Tue, 08 Oct 2024 00:00:00 +0200</pubDate>
        <link>https://blog.itprocloud.de/Dynamic-Device-Group-host-pool-session-host-resource-group/</link>
        <guid isPermaLink="true">https://blog.itprocloud.de/Dynamic-Device-Group-host-pool-session-host-resource-group/</guid>
        
        
        <category>Windows Virtual Desktop</category>
        
        <category>Azure Virtual Desktop</category>
        
        <category>Entra</category>
        
      </item>
    
      <item>
        <title>OneDrive Clean-Up for Azure Virtual Desktop</title>
        <description>&lt;p&gt;Running OneDrive with Azure Virtual Desktop is a common scenario and enables users to work in a modern way with Teams and SharePoint. If FSLogix is used, there is a challenge in combination with OneDrive: Users can download OneDrive files to the host, and the data are stored in the profile. The profile size increases heavily and causes some extra costs on the storage account. &lt;/p&gt;

&lt;p&gt;Having so many OneDrive files stored in the profile may make no sense in every case - if a user access a file, the file is downloaded automatically (on demand). And it&amp;#39;s mostly fine to &amp;quot;unpin&amp;quot; the file later if the file is no longer needed. The files are downloaded fast, while AVD and OneDrive are in the Microsoft cloud. &lt;/p&gt;

&lt;h3 id=&quot;background&quot;&gt;Background:&lt;/h3&gt;

&lt;p&gt;OneDrive files can have three different states:
- &lt;strong&gt;Cloud:&lt;/strong&gt;
  The file content is in the cloud only. The file system simulates that the file exists. While the content is not on the disk, the files don&amp;#39;t need storage on the device. If a user opens such a file, the content is downloaded, and the file state change to On-Device.&lt;br&gt;
- &lt;strong&gt;On-Device:&lt;/strong&gt;
  The file content is also on the local disk, and the files are using local storage.
- &lt;strong&gt;Always:&lt;/strong&gt;
  The file content is also on the local disk, and the files are using local storage. OneDrive wouldn&amp;#39;t change the state to &amp;quot;Cloud&amp;quot;. &lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/ODClaenUp-02.png&quot; alt=&quot;&quot;&gt;
&lt;br/&gt;&lt;/p&gt;

&lt;p&gt;OneDrive can change the state to &amp;quot;Cloud&amp;quot; on normal Windows 10/11 devices using storage sense. Based on the implementation of storage sense, this is not working for Azure Virtual Desktop (Multi-Session) with FSLogix profiles.&lt;/p&gt;

&lt;p&gt;A solution to avoid profile blotting in combination with FSLogix is changing the state of OneDrive files to &amp;quot;Cloud&amp;quot; (unpin files). If files are unpinned, they are no longer using local storage, and the &amp;quot;Disk Compaction&amp;quot; of FSLogix would reduce the profile automatically over time (or have more space left for user data).&lt;/p&gt;

&lt;p&gt;I built a small tool to solve this challenge (I didn&amp;#39;t find a native solution). The tool is called OneDrive CleanUp. OneDrive CleanUp can run in two ways:
- Started automatically with the login of the user (after the installation, it creates a link in the start-up folder of the start menu). It directly starts in the background and validates and maybe unpin OneDrive files. This process is repeated every 30 minutes and during the logoff of the user.
- Start the program with the parameter /RunOnce during the logoff using a (group) policy.&lt;/p&gt;

&lt;p&gt;I prefer the first method to ensure that OneDrive has time to react to the unpinning of files.&lt;/p&gt;

&lt;p&gt;Example for method 2:
&lt;img src=&quot;../assets/images/ODClaenUp-03.png&quot; alt=&quot;&quot;&gt;
&lt;br/&gt;&lt;/p&gt;

&lt;h3 id=&quot;result&quot;&gt;Result&lt;/h3&gt;

&lt;p&gt;In my test, my profile grew to 8 GByte while I pinned some files in OneDrive, and after logoff, the profile went back to 800 MByte while the tool unpinned the OneDrive files.&lt;/p&gt;

&lt;h3 id=&quot;logging-and-configuration&quot;&gt;Logging and configuration&lt;/h3&gt;

&lt;p&gt;The default configuration can be changed by setting the following values to the registry HKLM:\SOFTWARE\ITProCloud\OneDriveCleanUp&lt;/p&gt;

&lt;table&gt;&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Key&lt;/th&gt;
&lt;th&gt;Type&lt;/th&gt;
&lt;th&gt;Value&lt;/th&gt;
&lt;th&gt;Default value&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Enabled&lt;/td&gt;
&lt;td&gt;Reg_DWORD&lt;/td&gt;
&lt;td&gt;If false, the application will not check the files&lt;/td&gt;
&lt;td&gt;1=true&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;RunEachMinutes&lt;/td&gt;
&lt;td&gt;Reg_DWORD&lt;/td&gt;
&lt;td&gt;Check OneDrive files each minutes&lt;/td&gt;
&lt;td&gt;30&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;AlwaysUnpinFilesOlderThenDays&lt;/td&gt;
&lt;td&gt;Reg_DWORD&lt;/td&gt;
&lt;td&gt;Unpin files older then days (0: disabled )&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;AllowMbytesOnDisk&lt;/td&gt;
&lt;td&gt;Reg_DWORD&lt;/td&gt;
&lt;td&gt;Allow the configured value in MByte on the local disk&lt;/td&gt;
&lt;td&gt;5120&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;IgnoreFilesContaining&lt;/td&gt;
&lt;td&gt;Reg_SZ&lt;/td&gt;
&lt;td&gt;String with separated values (;). If the path of a file contains one of the values, the file is ignored&lt;/td&gt;
&lt;td&gt;Empty&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;RunAtLogoff&lt;/td&gt;
&lt;td&gt;Reg_DWORD&lt;/td&gt;
&lt;td&gt;Run a last check while the user log off (can delay the logoff)&lt;/td&gt;
&lt;td&gt;0=false&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;

&lt;p&gt;&lt;br/&gt;
OneDrive CleanUp writes a log file to %AppData%\ITProCloud\OneDriveCleanUp.log. &lt;/p&gt;

&lt;p&gt;Example: 
&lt;img src=&quot;../assets/images/ODClaenUp-01.png&quot; alt=&quot;&quot;&gt;
&lt;br/&gt;&lt;/p&gt;

&lt;h3 id=&quot;how-does-it-work&quot;&gt;How does it work&lt;/h3&gt;

&lt;p&gt;OneDrive CleanUp regularly checks all OneDrive paths and calculates the size of the disk. If the size is larger than the configured maximum size (AllowMbytesOnDisk), it unpins files to go under the configured size. It starts from the oldest to the newest file based on the LastAccessTime property.&lt;/p&gt;

&lt;p&gt;&lt;br/&gt;&lt;/p&gt;

&lt;h3 id=&quot;release-notes&quot;&gt;Release notes&lt;/h3&gt;

&lt;table&gt;&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Release&lt;/th&gt;
&lt;th&gt;Date&lt;/th&gt;
&lt;th&gt;Changes &amp;amp; Notes&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;1.0.4&lt;/td&gt;
&lt;td&gt;2023-05-04&lt;/td&gt;
&lt;td&gt;Initial&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.0.5&lt;/td&gt;
&lt;td&gt;2023-07-13&lt;/td&gt;
&lt;td&gt;Fix: Files larger than 2 GByte were counted wrong&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.0.6&lt;/td&gt;
&lt;td&gt;2023-10-17&lt;/td&gt;
&lt;td&gt;Fix: Files larger than 4 GByte were counted wrong&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.0.7&lt;/td&gt;
&lt;td&gt;2024-10-03&lt;/td&gt;
&lt;td&gt;Add: Feature: RunAtLogoff with a default value of 0&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;

&lt;p&gt;&lt;br/&gt;&lt;/p&gt;

&lt;h3 id=&quot;download&quot;&gt;Download&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;../assets/files/OneDriveCleanUp.msi&quot;&gt;&lt;img src=&quot;../assets/icons/download.png&quot; alt=&quot;Download&quot;&gt; &lt;strong&gt;Download the latest release from 10/03/2024&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please feel free to send me ideas for improvements.&lt;/p&gt;
</description>
        <pubDate>Thu, 03 Oct 2024 00:00:00 +0200</pubDate>
        <link>https://blog.itprocloud.de/OneDrive-Clean-Up-For-Azure-Virtual-Desktop-AVD-agains-Profile-Blotting/</link>
        <guid isPermaLink="true">https://blog.itprocloud.de/OneDrive-Clean-Up-For-Azure-Virtual-Desktop-AVD-agains-Profile-Blotting/</guid>
        
        
        <category>Windows Virtual Desktop</category>
        
        <category>Azure Virtual Desktop</category>
        
      </item>
    
      <item>
        <title>AVD Need Assistance - NAT shape is Undetermined when probing turn:20.202.248.2:3478?Udp TURN relay health check failed ...</title>
        <description>&lt;h1 id=&quot;current-issues-avd-agent-reports-an-issue-and-brings-the-hosts-into-need-assistance&quot;&gt;Current issues: AVD agent reports an issue and brings the hosts into &lt;strong&gt;&amp;quot;Need Assistance&amp;quot;&lt;/strong&gt;&lt;/h1&gt;

&lt;p&gt;In the last September week, I got a lot of emails and team messages. Customers are seeing the following error message on session hosts in the Azure Portal and in Hydra:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;NAT shape is Undetermined when probing [turn:20.202.248.2:3478?Udp] TURN relay health check failed for server [turn:20.202.248.2:3478?Udp] - One or more errors occurred.-&amp;gt;Timed out waiting for Receive to complete - Code: -2147467259 - 2024-09-26T07:39:15.704086Z&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The session hosts are also going into the &lt;strong&gt;&amp;quot;Need Assistance&amp;quot;&lt;/strong&gt; mode - even if users can still log in and continue working. It&amp;#39;s also reported, that the time stamp of the error message stays.&lt;/p&gt;

&lt;p&gt;The issue is related to the AVD agent testing a UDP connection to the given (Microsoft) IP. This is a normal behaviour and can fail if customers are not allowing this connection through the firewall. If that is not working, connections are made via TCP. So far - so good. Unfortunately, the AVD agent shows this as an error, bringing the host into the &lt;strong&gt;&amp;quot;Need Assistance&amp;quot;&lt;/strong&gt; mode.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Important: Session hosts in this state do not count on the capacity of a pool in Hydra. It also can break autoscaling if you run Hydra version 1.0.8.7 or less. Also hosts in this state are **not&lt;/strong&gt; deallocated automatically - they stay running until the error disappears.**&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/NA-Hydra.png&quot; alt=&quot;Download&quot;&gt;&lt;/p&gt;

&lt;h2 id=&quot;what-can-we-do&quot;&gt;What can we do?&lt;/h2&gt;

&lt;h3 id=&quot;allowing-udp-communication-to-specific-ports-preferred&quot;&gt;Allowing UDP communication to specific ports (preferred)&lt;/h3&gt;

&lt;p&gt;You can configure the firewall to allow communication to the mentioned ports if that is an option for your environment/company. In short, the following communication from the hosts to the internet must be possible:
- Target: 20.202.0.0/16, Port 3478 UDP
- Target: 20.202.0.0/16, Port 443 TCP
- &lt;a href=&quot;https://learn.microsoft.com/en-us/azure/virtual-desktop/rdp-shortpath?tabs=public-networks&quot;&gt;Link to the blog post&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can test the connection with the tool &lt;a href=&quot;https://learn.microsoft.com/en-us/azure/virtual-desktop/troubleshoot-rdp-shortpath&quot;&gt;avdnettest.exe&lt;/a&gt; from Microsoft:
&lt;img src=&quot;../assets/images/NA-avdnettest.png&quot; alt=&quot;Download&quot;&gt;&lt;/p&gt;

&lt;p&gt;&lt;br/&gt;&lt;/p&gt;

&lt;h3 id=&quot;update-hydra-also-preferred&quot;&gt;Update Hydra (also preferred)&lt;/h3&gt;

&lt;p&gt;There is a new release of Hydra available from 09/30/2024 (v1.0.8.7) containing a hotfix to handle failed hosts. This will not remove the error message but should show the correct sessions and handle autoscaling also for hosts in the &lt;strong&gt;&amp;quot;Need Assistance&amp;quot;&lt;/strong&gt; mode. Please monitor your environment after update/hotfix: &lt;a href=&quot;https://github.com/MarcelMeurer/WVD-Hydra?tab=readme-ov-file#updates-and-releases&quot;&gt;How to update Hydra&lt;/a&gt;
&lt;br/&gt;&lt;/p&gt;

&lt;h3 id=&quot;disabling-udp-temporary-workaround&quot;&gt;Disabling UDP temporary (workaround)&lt;/h3&gt;

&lt;p&gt;If option one is not possible, or the error messages are not disappearing, we can disable the use of UDP &lt;a href=&quot;https://admx.help/?Category=Windows_10_2016&amp;Policy=Microsoft.Policies.TerminalServer::TS_SELECT_TRANSPORT&quot;&gt;via GPO&lt;/a&gt; or reg keys. The following script disables UDP, and it should also remove the error message. You can &lt;a href=&quot;https://github.com/MarcelMeurer/WVD-Hydra/blob/main/README.md#scripts-and-script-collections&quot;&gt;create the script in Hydra&lt;/a&gt; and run it on the hosts (test it with one host first):&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-&quot; data-lang=&quot;&quot;&gt;New-ItemProperty -Path &quot;HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services&quot; -Name &quot;SelectTransport&quot; -Value 1 -force # default: 0

# Reset old failure state
if (Test-Path -Path &quot;HKLM:\SOFTWARE\Microsoft\RDInfraAgent\HealthCheckReport&quot;) {
    Remove-ItemProperty -Path &quot;HKLM:\SOFTWARE\Microsoft\RDInfraAgent\HealthCheckReport&quot; -Name &quot;AgentHealthCheckReport&quot; -ErrorAction SilentlyContinue
    Remove-ItemProperty -Path &quot;HKLM:\SOFTWARE\Microsoft\RDInfraAgent\HealthCheckReport&quot; -Name &quot;AgentHealthCheckTimestamp&quot; -ErrorAction SilentlyContinue
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you rollout a new host, make sure to reapply this settings. That can be done in Hydra -&amp;gt; Host Pool -&amp;gt; New Session Host Rollout -&amp;gt; Run script or script collection after deployment
&lt;br/&gt;&lt;/p&gt;

&lt;hr&gt;

&lt;p&gt;It&amp;#39;s also a good idea to open a ticket to let Microsoft fix this issue with the service/AVD agent.&lt;/p&gt;
</description>
        <pubDate>Thu, 26 Sep 2024 00:00:00 +0200</pubDate>
        <link>https://blog.itprocloud.de/AVD-Need-Assistance-NAT-shape-is-Undetermined-when-probing-TURN-relay-health-check-failed/</link>
        <guid isPermaLink="true">https://blog.itprocloud.de/AVD-Need-Assistance-NAT-shape-is-Undetermined-when-probing-TURN-relay-health-check-failed/</guid>
        
        
        <category>Windows Virtual Desktop</category>
        
        <category>Azure Virtual Desktop</category>
        
      </item>
    
      <item>
        <title>CountrySwitch - First Logon Experience and language selector and an app starter for remote apps on network paths for AVD</title>
        <description>&lt;h2 id=&quot;first-logon-experience-and-language-selector-and-an-app-starter-for-remote-apps-on-network-paths&quot;&gt;First Logon Experience and language selector and an app starter for remote apps on network paths&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;../assets/files/CountrySwitch.msi&quot;&gt;&lt;img src=&quot;../assets/icons/download.png&quot; alt=&quot;Download&quot;&gt; &lt;strong&gt;Download the latest release from 09/16/2024&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;select-the-language-users&quot;&gt;Select the language (users)&lt;/h2&gt;

&lt;p&gt;In some environments, customers are running Azure on Windows 10/11 with multiple language packs installed. After the first login, users have to choose their language to customize the environment - that is not so easy, while users have to open the language settings and select the language. The first steps are outside the user&amp;#39;s language and are not easy to do for everyone.&lt;/p&gt;

&lt;p&gt;I built a tool that makes it easier for users to select their language by clicking on the right flag. Currently, the following features are available:&lt;/p&gt;

&lt;p&gt;Feature regarding the language selection:
- The tool shows the installed language packages by a flag of the countries.
- A welcome message in the present language welcomes the users.
- The user selects the language settings with a click on the flag.
- Hovering the mouse over a flag shows the country and language name.
- The app configures the language settings (and does one logoff to apply the setting).
- The PowerShell script CountrySwitch-User.ps1 in the program files folder is started to do some optional customizing (language code is in $languageTag)&lt;/p&gt;

&lt;p&gt;CountrySwitch is linked in all users&amp;#39; start menu:
- Startup: With parameter \/RunOnce - Starts CountrySwitch at logon. The user will see the language selector only if the user is new and didn&amp;#39;t select a language once (HKCU:\SOFTWARE\ITProCloud\CountrySwitch\Completed is set to 1 )
- Direct: Without parameters - Users can star CountrySwitch manually to select the language&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Note on Remote Apps&lt;/strong&gt;: Remote apps are ignoring the autostart folder. To have CountrySwitch enabled for remote app, please configure a local Startup script (local policy for users) with the following parameters:
Name of script: &amp;quot;C:\Program Files\ITProCloud.de\CountrySwitch\CountrySwitch.exe&amp;quot;
Parameters: \/runonce&lt;/p&gt;

&lt;h2 id=&quot;app-starter-for-remote-apps&quot;&gt;App Starter for remote apps&lt;/h2&gt;

&lt;p&gt;CountrySwitch can also start a local or an application on a file share (which normally does not work directly with AVD). Publish CountrySwitch as a remote app with the following parameters:
- &lt;code&gt;CountrySwitch.exe /remoteapp &amp;quot;&amp;lt;path to executable with parameters&amp;gt;&amp;quot; &amp;quot;&amp;lt;Working directory&amp;gt;&amp;quot;&lt;/code&gt;
- &lt;code&gt;CountrySwitch.exe /remoteapp &amp;quot;\\&amp;lt;path&amp;gt;\&amp;lt;share&amp;gt;\finance.exe /db=vm1&amp;quot; &amp;quot;\\&amp;lt;path&amp;gt;\&amp;lt;share&amp;gt;&amp;quot;&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;If a remote app is started with CountrySwitch, CountrySwitch first starts the PowerShell script CountrySwitch-App.ps1 in the program files folder to do some optional customization. The following parameters are set in the script:&lt;/p&gt;

&lt;p&gt;Example:
&lt;code&gt;
$languageTag = &amp;quot;unknown&amp;quot;,
$appCommandline = &amp;quot;\\&amp;lt;path&amp;gt;\&amp;lt;share&amp;gt;\finance.exe /db=vm1&amp;quot;,
$appWorkingDir = &amp;quot;\\&amp;lt;path&amp;gt;\&amp;lt;share&amp;gt;&amp;quot;,
$appParameter = &amp;quot;/db=vm1&amp;quot;,
$appExecutable = &amp;quot;finance.exe&amp;quot;
&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;The application starts after the PowerShell script finishes (CountrySwitch will run hidden and terminates after the start of the application (e.g., finance.exe).&lt;/p&gt;

&lt;h2 id=&quot;logging-and-configuration&quot;&gt;Logging and configuration&lt;/h2&gt;

&lt;p&gt;CountrySwitch logs into %AppData%\ITProCloud&lt;/p&gt;

&lt;p&gt;There are the following reg keys to optionally configure CountrySwitch (set the keys and value to modify the default settings):&lt;/p&gt;

&lt;p&gt;HKLM:\SOFTWARE\Policies\ITProCloud\CountrySwitch (alls values are dword - 1 is true; 0 is false)&lt;/p&gt;

&lt;table&gt;&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Key&lt;/th&gt;
&lt;th&gt;Value&lt;/th&gt;
&lt;th&gt;Default value&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Enabled&lt;/td&gt;
&lt;td&gt;If false, the application will not show up (except for /remoteapp (App starter mode))&lt;/td&gt;
&lt;td&gt;true&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ExitOnRunOnceCompleted&lt;/td&gt;
&lt;td&gt;If the app is started with /runonce and the user has already completed the process, the application will not show up&lt;/td&gt;
&lt;td&gt;true&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ExitOnSingleLanguage&lt;/td&gt;
&lt;td&gt;If only one language is installed, don&amp;#39;t show up&lt;/td&gt;
&lt;td&gt;true&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;LogoffUserAfterSelectingNewLanguage&lt;/td&gt;
&lt;td&gt;Logoff user after selecting a new language&lt;/td&gt;
&lt;td&gt;true&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;LogoffUserAfterSelectingSameLanguage&lt;/td&gt;
&lt;td&gt;Logoff user after selecting the same language as the user is still using&lt;/td&gt;
&lt;td&gt;false&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;RunUserScriptAfterSelectingLanguage&lt;/td&gt;
&lt;td&gt;Runs the ps script CountrySwitch-User.ps1 -languageTag {xx-YY} after the user selects a language&lt;/td&gt;
&lt;td&gt;true&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;DisableUserScriptForAppStarterMode&lt;/td&gt;
&lt;td&gt;If true, the app starter mode for a remote app will no longer trigger CountrySwitch-App before starting the application&lt;/td&gt;
&lt;td&gt;true&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;

&lt;p&gt;&lt;br/&gt;&lt;/p&gt;

&lt;h2 id=&quot;release-notes&quot;&gt;Release notes&lt;/h2&gt;

&lt;table&gt;&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Release&lt;/th&gt;
&lt;th&gt;Date&lt;/th&gt;
&lt;th&gt;Changes &amp;amp; Notes&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;1.1.3&lt;/td&gt;
&lt;td&gt;2023-05-04&lt;/td&gt;
&lt;td&gt;Initial&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.1.4&lt;/td&gt;
&lt;td&gt;2023-05-10&lt;/td&gt;
&lt;td&gt;Update: CountrySwitch-User.ps1 had a typo&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.1.7&lt;/td&gt;
&lt;td&gt;2023-05-11&lt;/td&gt;
&lt;td&gt;Fix: Avoid showing MSI installation screen for users if package unaccessible&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;1.1.9&lt;/td&gt;
&lt;td&gt;2024-09-16&lt;/td&gt;
&lt;td&gt;Fix: Prevents that the logoff message is shown multiple times if the user multiple clicks on a flag&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;

&lt;p&gt;&lt;a href=&quot;../assets/files/CountrySwitch.msi&quot;&gt;&lt;img src=&quot;../assets/icons/download.png&quot; alt=&quot;Download&quot;&gt; &lt;strong&gt;Download the latest release from 09/16/2024&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please feel free to send me ideas for improvements.&lt;/p&gt;
</description>
        <pubDate>Mon, 16 Sep 2024 00:00:00 +0200</pubDate>
        <link>https://blog.itprocloud.de/CountrySwitch-Select-Language-on-first-start-and-an-appstarter-for-remoteapps/</link>
        <guid isPermaLink="true">https://blog.itprocloud.de/CountrySwitch-Select-Language-on-first-start-and-an-appstarter-for-remoteapps/</guid>
        
        
        <category>Windows Virtual Desktop</category>
        
        <category>Azure Virtual Desktop</category>
        
      </item>
    
      <item>
        <title>Improve AVD User Experience: Warm-Up to decreas User login time</title>
        <description>&lt;p&gt;If you are running Azure Virtual Desktop with FSLogix, the first login to a host takes longer than the following logins. I also wrote about this effect (I call is Cold vs. Warm start) a few weeks ago here: &lt;a href=&quot;https://lnkd.in/eEQHP5gA&quot;&gt;https://lnkd.in/eEQHP5gA&lt;/a&gt; and &lt;a href=&quot;https://www.linkedin.com/posts/marcelmeurer_azurevirtualdesktop-coldstart-warmstart-activity-7227298731124019200--nsM&quot;&gt;https://www.linkedin.com/posts/marcelmeurer_azurevirtualdesktop-coldstart-warmstart-activity-7227298731124019200--nsM&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In short, If a VM is started in Azure, the first login of a user takes much longer than the login of the following users to this VM. And: It makes no difference if the first user logs in one or 30 minutes after starting the VM. I did a lot of tests by running &lt;em&gt;ProcMon, FileActivityWatch, and RegistryChangesView&lt;/em&gt; in the system context to capture events during the first login 🤓. I can clearly see dependencies to AppX packages on the VM. In my tests, processing of AppX packages for the first user took 120 seconds, and for the next user, only a few seconds. Right now, I cannot reproduce the first AppX processing without a user logging into the host (but I&amp;#39;m working on that). The first user will also see a black screen during the login.&lt;/p&gt;

&lt;p&gt;Therefore, I did another test: Create a temporary local user on the VM directly after the start and make a login (autogenerated passwords and direct deletion of the users after the login).&lt;/p&gt;

&lt;p&gt;The result is as expected: After the start of the VM, the warmup user triggers the AppX processing and other &amp;quot;initializations.&amp;quot; The next - regular - user experiences a much faster login while that is technically the second login for the VM.&lt;/p&gt;

&lt;p&gt;I wrote a script to automate a local logon after each VM/host&amp;#39;s start. That may not be the best way to handle this solution, but it is a workaround until I find a more pragmatic solution without a warm-up user.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/AVD-UX-WarmUp-01.png&quot; alt=&quot;&quot;&gt;
&lt;img src=&quot;../assets/images/AVD-UX-WarmUp-02.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;h2 id=&quot;how-does-it-work&quot;&gt;How does it work?&lt;/h2&gt;

&lt;p&gt;The script is started directly after the start of a VM/host and runs in the context of the computer. The following steps happen:
- Temporarily, allow RDS logon without validation computer certificates (only for the system account)
- Generate a local user (warm-up user) with a random password. The account automatically expires after 10 minutes
- Add the user to the Remote Desktop User Group
- Configure the sign-on via RDS to localhost
- The warm-up user connects via RDS to localhost (the first user logon)
- Wait 5 minutes
- Logoff the user
- Remove the user account
- Remove the user profile from disk&lt;/p&gt;

&lt;p&gt;There are some additional error-handling routines in the script. &lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Pro tip:&lt;/strong&gt; If you ever search for a way to get session information with PowerShell without parsing qwinsta.exe or quser.exe, check the script. It also contains a PowerShell method to log off a specific session.&lt;/p&gt;

&lt;h2 id=&quot;install-the-warm-up-user-script&quot;&gt;Install the warm-up user script&lt;/h2&gt;

&lt;p&gt;You can install the script on an existing host or on your Golden Master / Template VM (which you hopefully capture loss-less with &lt;a href=&quot;https://blog.itprocloud.de/Windows-Virtual-Desktop-Admin&quot;&gt;WVDAdmin&lt;/a&gt; or &lt;a href=&quot;https://github.com/MarcelMeurer/WVD-Hydra&quot;&gt;Hydra for Azure Virtual Desktop&lt;/a&gt;). Copy the script to the VM and run the following command in an administrative PowerShell:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;.\WarmUp.ps1 -Mode Install&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;This copies the script to C:\windows\WarmUp.ps1 and creates a scheduled task to start the script automatically with the computer.&lt;/p&gt;

&lt;h2 id=&quot;the-script&quot;&gt;The script&lt;/h2&gt;

&lt;p&gt;Save it as WarmUp.ps1 or download it from here: &lt;a href=&quot;https://gist.github.com/MarcelMeurer/1044690ed2619c145305e8cc335948a5&quot;&gt;WarmUp.ps1&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-&quot; data-lang=&quot;&quot;&gt;param(
    [string] $Mode
)

Add-Type -Language CSharp -TypeDefinition @&apos;
using System;
using System.Linq;
using System.Runtime.InteropServices;
using System.Collections.Generic;
namespace Rds {
    public static class Sessions {
        [DllImport(&quot;wtsapi32.dll&quot;)]
        static extern IntPtr WTSOpenServer([MarshalAs(UnmanagedType.LPStr)] String pServerName);
        [DllImport(&quot;wtsapi32.dll&quot;)]
        static extern void WTSCloseServer(IntPtr hServer);
        [DllImport(&quot;wtsapi32.dll&quot;)]
        static extern Int32 WTSEnumerateSessions(IntPtr hServer,
            [MarshalAs(UnmanagedType.U4)] Int32 Reserved,
            [MarshalAs(UnmanagedType.U4)] Int32 Version, ref IntPtr ppSessionInfo,
            [MarshalAs(UnmanagedType.U4)] ref Int32 pCount);
        [DllImport(&quot;wtsapi32.dll&quot;)]
        static extern void WTSFreeMemory(IntPtr pMemory);
        [DllImport(&quot;Wtsapi32.dll&quot;)]
        static extern bool WTSQuerySessionInformation(System.IntPtr hServer, int sessionId, WTS_INFO_CLASS wtsInfoClass, out System.IntPtr ppBuffer, out uint pBytesReturned);
        [DllImport(&quot;Wtsapi32.dll&quot;)]
        static extern bool WTSLogoffSession(System.IntPtr hServer, int sessionId, bool wait);
        [StructLayout(LayoutKind.Sequential)]
        private struct WTS_SESSION_INFO {
            public Int32 SessionID;
            [MarshalAs(UnmanagedType.LPStr)]
            public String pWinStationName;
            public WtsConnect State;
        }
        public enum WTS_INFO_CLASS {
            WTSInitialProgram,
            WTSApplicationName,
            WTSWorkingDirectory,
            WTSOEMId,
            WTSSessionId,
            WTSUserName,
            WTSWinStationName,
            WTSDomainName,
            WTSConnectState,
            WTSClientBuildNumber,
            WTSClientName,
            WTSClientDirectory,
            WTSClientProductId,
            WTSClientHardwareId,
            WTSClientAddress,
            WTSClientDisplay,
            WTSClientProtocolType,
            WTSIdleTime,
            WTSLogonTime,
            WTSIncomingBytes,
            WTSOutgoingBytes,
            WTSIncomingFrames,
            WTSOutgoingFrames,
            WTSClientInfo,
            WTSSessionInfo,
            WTSSessionInfoEx,
            WTSConfigInfo,
            WTSValidationInfo,
            WTSSessionAddressV4,
            WTSIsRemoteSession
        }
        public enum WtsConnect {
            Active,
            Connected,
            ConnectQuery,
            Shadow,
            Disconnected,
            Idle,
            Listen,
            Reset,
            Down,
            Init
        }
        public class WtsSessionInformation {
            public string InitialProgram;
            public string ApplicationName;
            public string WorkingDirectory;
            public string OEMId;
            public int SessionId;
            public string UserName;
            public string WinStationName;
            public string DomainName;
            public WtsConnect ConnectState;
            public string ConnectStateString;
            public int ClientBuildNumber;
            public string ClientName;
            public string ClientDirectory;
        }
        public static IntPtr OpenServer(String name) {
            IntPtr server = WTSOpenServer(name);
            return server;
        }
        public static void CloseServer(IntPtr serverHandle) {
            WTSCloseServer(serverHandle);
        }
        public static bool LogoffSession(int id, bool waitForLogoff) {
            IntPtr serverHandle = IntPtr.Zero;
            serverHandle = OpenServer(Environment.MachineName);
            IntPtr sessionInfoPtr = IntPtr.Zero;
            try {
                return WTSLogoffSession(serverHandle, id, waitForLogoff);
            } catch (Exception e) {
                Console.WriteLine(&quot;Exception querying session information: &quot; + e.ToString());
            } finally {
                WTSFreeMemory(sessionInfoPtr);
                CloseServer(serverHandle);
            }
            return false;
        }
        public static WtsSessionInformation GetSession(string userName) {
            var sessions=GetSessions();
            return sessions.FirstOrDefault(n=&amp;gt;string.Equals(n.UserName, userName, StringComparison.InvariantCultureIgnoreCase));

        }
        public static List &amp;lt; WtsSessionInformation &amp;gt; GetSessions() {
            var wtsList = new List &amp;lt; WtsSessionInformation &amp;gt; ();
            IntPtr serverHandle = IntPtr.Zero;
            serverHandle = OpenServer(Environment.MachineName);
            IntPtr sessionInfoPtr = IntPtr.Zero;
            try {
                IntPtr sPtr = IntPtr.Zero;
                Int32 sessionCount = 0;
                Int32 retVal = WTSEnumerateSessions(serverHandle, 0, 1, ref sessionInfoPtr, ref sessionCount);
                Int32 dataSize = Marshal.SizeOf(typeof(WTS_SESSION_INFO));
                Int64 currentSession = (long) sessionInfoPtr;
                uint bytes = 0;
                if (retVal != 0) {
                    for (int i = 0; i &amp;lt; sessionCount; i++) {
                        WTS_SESSION_INFO si = (WTS_SESSION_INFO) Marshal.PtrToStructure((System.IntPtr) currentSession, typeof(WTS_SESSION_INFO));
                        currentSession += dataSize;
                        var wts = new WtsSessionInformation();
                        if (WTSQuerySessionInformation(serverHandle, si.SessionID, WTS_INFO_CLASS.WTSUserName, out sPtr, out bytes)) {
                            wts.UserName = Marshal.PtrToStringAnsi(sPtr);
                            WTSFreeMemory(sPtr);
                        }
                        if (WTSQuerySessionInformation(serverHandle, si.SessionID, WTS_INFO_CLASS.WTSDomainName, out sPtr, out bytes)) {
                            wts.DomainName = Marshal.PtrToStringAnsi(sPtr);
                            WTSFreeMemory(sPtr);
                        }
                        if (WTSQuerySessionInformation(serverHandle, si.SessionID, WTS_INFO_CLASS.WTSWinStationName, out sPtr, out bytes)) {
                            wts.WinStationName = Marshal.PtrToStringAnsi(sPtr);
                            WTSFreeMemory(sPtr);
                        }
                        if (WTSQuerySessionInformation(serverHandle, si.SessionID, WTS_INFO_CLASS.WTSSessionId, out sPtr, out bytes)) {
                            wts.SessionId = Marshal.ReadInt32(sPtr);
                            WTSFreeMemory(sPtr);
                        }
                        if (WTSQuerySessionInformation(serverHandle, si.SessionID, WTS_INFO_CLASS.WTSInitialProgram, out sPtr, out bytes)) {
                            wts.InitialProgram = Marshal.PtrToStringAnsi(sPtr);
                            WTSFreeMemory(sPtr);
                        }
                        if (WTSQuerySessionInformation(serverHandle, si.SessionID, WTS_INFO_CLASS.WTSApplicationName, out sPtr, out bytes)) {
                            wts.ApplicationName = Marshal.PtrToStringAnsi(sPtr);
                            WTSFreeMemory(sPtr);
                        }
                        if (WTSQuerySessionInformation(serverHandle, si.SessionID, WTS_INFO_CLASS.WTSWorkingDirectory, out sPtr, out bytes)) {
                            wts.WorkingDirectory = Marshal.PtrToStringAnsi(sPtr);
                            WTSFreeMemory(sPtr);
                        }
                        if (WTSQuerySessionInformation(serverHandle, si.SessionID, WTS_INFO_CLASS.WTSConnectState, out sPtr, out bytes)) {
                            wts.ConnectState = (WtsConnect) Marshal.ReadInt32(sPtr);
                            wts.ConnectStateString = wts.ConnectState.ToString();
                            WTSFreeMemory(sPtr);
                        }
                        if (WTSQuerySessionInformation(serverHandle, si.SessionID, WTS_INFO_CLASS.WTSClientBuildNumber, out sPtr, out bytes)) {
                            wts.ClientBuildNumber = Marshal.ReadInt32(sPtr);
                            WTSFreeMemory(sPtr);
                        }
                        if (WTSQuerySessionInformation(serverHandle, si.SessionID, WTS_INFO_CLASS.WTSClientName, out sPtr, out bytes)) {
                            wts.ClientName = Marshal.PtrToStringAnsi(sPtr);
                            WTSFreeMemory(sPtr);
                        }
                        if (WTSQuerySessionInformation(serverHandle, si.SessionID, WTS_INFO_CLASS.WTSClientDirectory, out sPtr, out bytes)) {
                            wts.ClientDirectory = Marshal.PtrToStringAnsi(sPtr);
                            WTSFreeMemory(sPtr);
                        }
                        if (!string.IsNullOrEmpty(wts.UserName)) wtsList.Add(wts);
                    }
                }
                return wtsList;
            } catch (Exception e) {
                Console.WriteLine(&quot;Exception querying session information: &quot; + e.ToString());
            } finally {
                WTSFreeMemory(sessionInfoPtr);
                CloseServer(serverHandle);
            }
            return null;
        }
    }
}
&apos;@

$LogDir=&quot;$($env:windir)\system32\LogFiles&quot;
$LogFile=&quot;$($LogDir)\AVD.WarmUp.log&quot;
function LogWriter($message) {
    $message = &quot;$(Get-Date ([datetime]::UtcNow) -Format &quot;o&quot;) $message&quot;
    write-host($message)
    if ([System.IO.Directory]::Exists($LogDir)) { try { write-output($message) | Out-File $LogFile -Append } catch {} }
}

if ($mode -like &quot;install&quot;) {
    LogWriter(&quot;Copy script to windir&quot;)
    Copy-Item &quot;$($MyInvocation.InvocationName)&quot; -Destination ($env:windir + &quot;\WarmUp.ps1&quot;) 

    LogWriter(&quot;Creating schedule task to run the script at startup&quot;)
    $action = New-ScheduledTaskAction -Execute &quot;$env:windir\System32\WindowsPowerShell\v1.0\Powershell.exe&quot; -Argument &quot;-executionPolicy Unrestricted -File `&quot;$($env:windir)\WarmUp.ps1`&quot;&quot;
    $trigger = New-ScheduledTaskTrigger -AtStartup
    $principal = New-ScheduledTaskPrincipal &apos;NT Authority\SYSTEM&apos; -RunLevel Highest
    $settingsSet = New-ScheduledTaskSettingsSet
    $task = New-ScheduledTask -Action $action -Principal $principal -Trigger $trigger -Settings $settingsSet 
    Register-ScheduledTask -TaskName &apos;ITPC-AVD-WarmUpUser&apos; -InputObject $task -ErrorAction Ignore
    Enable-ScheduledTask -TaskName &apos;ITPC-AVD-WarmUpUser&apos;
} else {

    $localUserName = &quot;warmup-user&quot;

    $characters = &apos;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#&apos; #$%^&amp;amp;*()-_=+[]{}|;:,.&amp;lt;&amp;gt;?&apos;
    $localUserPWPlain = -join (1..32 | ForEach-Object { Get-Random -InputObject $characters.ToCharArray() }) +&quot;!@1aA&quot;

    $localUserPW =  ConvertTo-SecureString -String $localUserPWPlain -AsPlainText -Force # https://www.sharepointdiary.com/2020/04/powershell-generate-random-password.html


    # Store default configuration
    LogWriter(&quot;Getting local configuration to use saved credentials for the warmup user&quot;)
    $oldAuthenticationLevelOverride=$null
    if (Test-Path &quot;HKCU:\Software\Microsoft\Terminal Server Client&quot;) {
        $oldAuthenticationLevelOverride = Get-ItemProperty -Path &quot;HKCU:\Software\Microsoft\Terminal Server Client&quot; -Name &quot;AuthenticationLevelOverride&quot; -ErrorAction SilentlyContinue
    } else {
        New-Item -Path &quot;HKCU:\Software\Microsoft\Terminal Server Client&quot; -Force -ErrorAction SilentlyContinue
    }
    if ($oldAuthenticationLevelOverride -eq $null) {$oldAuthenticationLevelOverride = 99} else {$oldAuthenticationLevelOverride = $oldAuthenticationLevelOverride.AuthenticationLevelOverride}


    try {
        LogWriter(&quot;Modifying configuration to login warmup user with stored credentials&quot;)
        # Set temporary configuration to allow user logins
        New-ItemProperty -Path &quot;HKCU:\Software\Microsoft\Terminal Server Client&quot; -Name &quot;AuthenticationLevelOverride&quot; -Value 0 -Force
        New-ItemProperty -Path &quot;HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services&quot; -Name &quot;DisablePasswordSaving&quot; -Value 1 -Force

        # Prepare temporary local user
        if ((Get-LocalUser -Name $localUserName -ErrorAction SilentlyContinue) -ne $null) {
            LogWriter(&quot;Removing existing local warmup user&quot;)
            Remove-LocalUser -Name $localUserName
        }
        LogWriter(&quot;Adding local user&quot;)
        $localUser = New-LocalUser -Name $localUserName -Password $localUserPW -AccountExpires (Get-Date).AddMinutes(10) -PasswordNeverExpires -UserMayNotChangePassword
        # Add user to remote desktop group
        LogWriter(&quot;Adding user to the remote desktop group&quot;)
        Add-LocalGroupMember -SID &quot;S-1-5-32-555&quot; -Member $localUserName -ErrorAction SilentlyContinue

        # Login user
        LogWriter(&quot;Adding credentials of the warmup user to the key store&quot;)
        cmdkey /generic:TERMSRV/localhost /user:&quot;$($env:Computername)\$($localUserName)&quot; /pass:$localUserPWPlain
        $startTime=Get-Date


    $i=0
    do {
            LogWriter(&quot;Login in user warmup user&quot;)
            if ($mstsc) {
        $mstsc.Kill()
        Start-Sleep -Seconds 6
        }
            $mstsc = Start-Process -PassThru -FilePath &quot;mstsc.exe&quot; -ArgumentList &quot;/v:localhost&quot;

            # Wait for the user to login 
            LogWriter(&quot;Waiting a few seconds&quot;)
            Start-Sleep -Seconds 20
            $i++        
    } while ([Rds.Sessions]::GetSession($localUserName) -eq $null -and $i -le 10)

        # Remove credentials
        LogWriter(&quot;Removing credentials from the key store&quot;)
        cmdkey /delete:TERMSRV/localhost

        # Check, if user is connected
        $session=[Rds.Sessions]::GetSession($localUserName)

        if ($session -eq $null) {
            LogWriter(&quot;Warning: Warm-up user is not connected. So, the workaround is not working for some reasons&quot;)
        } else {
            # Let the user for a while in the session and then logoff
            LogWriter(&quot;Let the user logged in for a while&quot;)
            Start-Sleep -Seconds 300
            LogWriter(&quot;Logoff user&quot;)
            [Rds.Sessions]::LogoffSession($session.SessionId, $true)
            # Remove profile of the user
            try {
                LogWriter(&quot;Delete profile of the warm-up user&quot;)
                @(Get-CimInstance -Class Win32_UserProfile | Where-Object { $_.Loaded -eq $false -and ($_.LocalPath.split(&apos;\&apos;)[-1] -like $localUserName -or $_.LocalPath.split(&apos;\&apos;)[-1] -like &quot;$($localUserName).*&quot;)}) | Remove-CimInstance

            } catch {
                LogWriter(&quot;Error: Cannot delete the profile of the warmup user: $_&quot;)
            }

        }
        LogWriter(&quot;Terminate mstsc.exe, if running&quot;)
        $mstsc.Kill()
    } catch {
        LogWriter(&quot;Error: $_&quot;)
    } finally {
        # Remove user
        LogWriter(&quot;Disable and remove user&quot;)
        Remove-LocalGroupMember -SID &quot;S-1-5-32-555&quot; -Member $localUserName
        Disable-LocalUser -Name  $localUserName -ErrorAction SilentlyContinue
        Remove-LocalUser -Name $localUserName -ErrorAction SilentlyContinue

        # Restore default configuration
        LogWriter(&quot;Restoring local configuration&quot;)
        if ($oldAuthenticationLevelOverride -eq 99) {
            Remove-ItemProperty &quot;HKCU:\Software\Microsoft\Terminal Server Client&quot; -Name &quot;AuthenticationLevelOverride&quot; -Force
        } else {
            New-ItemProperty -Path &quot;HKCU:\Software\Microsoft\Terminal Server Client&quot; -Name &quot;AuthenticationLevelOverride&quot; -Value $oldAuthenticationLevelOverride -Force
        }
    }
    LogWriter(&quot;Done&quot;)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
        <pubDate>Fri, 23 Aug 2024 00:00:00 +0200</pubDate>
        <link>https://blog.itprocloud.de/AVD-User-Experience-WarmUp-Script-To-Improve-User-Login-Logon-Time/</link>
        <guid isPermaLink="true">https://blog.itprocloud.de/AVD-User-Experience-WarmUp-Script-To-Improve-User-Login-Logon-Time/</guid>
        
        
        <category>Windows Virtual Desktop</category>
        
        <category>Azure Virtual Desktop</category>
        
      </item>
    
      <item>
        <title>Windows Update API issue - Exception from HRESULT: 0x8002802B (TYPE_E_ELEMENTNOTFOUND)</title>
        <description>&lt;p&gt;Windows gives you access to work with Windows Update on an API level. This is often used to find, download, and install new updates programmatically. That makes special sense in Azure Virtual Desktop, which allows us to trigger Windows Updates in a maintenance Windows where autoscale is disabled (I don&amp;#39;t want to imagine what happens if Windows shuts down during Windows Updates).&lt;/p&gt;

&lt;p&gt;Also, my solution, &lt;a href=&quot;https://github.com/MarcelMeurer/WVD-Hydra&quot;&gt;Hydra for Azure Virtual Desktop&lt;/a&gt;, uses the API to install Windows updates. That also includes draining, starting, installing, rebooting, etc. - all that is needed to update an existing host or a golden master. E.g.: Example of the script collection for an update:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;../assets/images/WSUS-API-05.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;Unfortunately, a Microsoft patch broke the functionality of the Windows Update API. That is documented here: &lt;a href=&quot;https://learn.microsoft.com/en-us/windows/release-health/status-windows-11-23h2#3351msgdesc&quot;&gt;https://learn.microsoft.com/en-us/windows/release-health/status-windows-11-23h2#3351msgdesc&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If you have a broken computer, you will see the following error message: Exception from HRESULT: 0x8002802B (TYPE_E_ELEMENTNOTFOUND)
&lt;img src=&quot;../assets/images/WSUS-API-01.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;The documentation also explains how to resolve the issue using a KIR (known issue recovery), which requires some handwork or automation. To make this as easy as possible for users of &lt;a href=&quot;https://github.com/MarcelMeurer/WVD-Hydra&quot;&gt;Hydra for Azure Virtual Desktop&lt;/a&gt;, I added the installation of the KIR as part of the &amp;quot;BuiltIn: OS Install Windows Updates&amp;quot;. Finally, it downloads and installs the KIR package and activates it. A final reboot is needed to bring it to work. If you are using the script as part of the script collection (see image above), it will first patch the host and install updates on the second try of running the &amp;quot;BuiltIn: OS Install Windows Updates&amp;quot;.&lt;/p&gt;

&lt;p&gt;To get the updated built-in scripts, you can click on the icon in the upper-right corner inside of the scripts page:
&lt;img src=&quot;../assets/images/WSUS-API-02.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;Finally, you should have the updated script (reload the site first):
&lt;img src=&quot;../assets/images/WSUS-API-03.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;After that, the Windows update procedure is working as expected:
&lt;img src=&quot;../assets/images/WSUS-API-04.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;

&lt;p&gt;Do you want to adapt your scripts? Here is my implementation. Feel free to use it:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-&quot; data-lang=&quot;&quot;&gt;# Install Windows security updates directly over the internet. VM downloads the packages directly from Microsoft using the Windows Update service. A restart is required after the installation, which can be done with the script collection &quot;OS Install Windows Updates&quot;.
$updateCollection = New-Object -ComObject Microsoft.Update.UpdateColl
$updateSearcher = New-Object -ComObject Microsoft.Update.Searcher
$updateSession = New-Object -ComObject Microsoft.Update.Session

$updatesKb=&quot;&quot;

write-host(&quot;Checking for updates&quot;)
$result = $updateSearcher.Search(&quot;IsInstalled=0 and Type=&apos;Software&apos; and IsHidden=0&quot;)

if ($result.Updates.Count -EQ 0) {
    write-host(&quot;No new updates found&quot;)
}
else {
    try {
        $updateDownloader = $updateSession.CreateUpdateDownloader()
        $result.Updates|foreach {
            write-host(&quot;Found: $($_.Title)&quot;)
            $updatesKb=$updatesKb+$_.KBArticleIDs+&quot; &quot;
            $updateCollection.Add($_)|Out-Null
        }
        write-host(&quot;Downloading updates&quot;)
        $updateDownloader.Updates = $updateCollection
        $updateDownloads = $updateDownloader.Download()
        if (($updateDownloads.HResult -EQ 0) -AND ($updateDownloads.ResultCode -EQ 2)) {
            write-host(&quot;Downloads success&quot;)
        }
        else {
            write-host(&quot;Downloads failed&quot;)
            Write-host(&quot;ScriptReturnMessage:{Download failed}:ScriptReturnMessage&quot;)
            exit
        }
        write-host(&quot;Installing updates&quot;)
        $updateInstaller = New-Object -ComObject Microsoft.Update.Installer
        $updateInstaller.Updates = $updateCollection
        $updateDownloads = $updateInstaller.Install()

        write-host(&quot;Applied updates: $updatesKb&quot;)
    } catch {
        if (($_ -like &quot;*0x8002802B*&quot;) -and (Get-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides&quot; -Name &quot;1931709068&quot; -ErrorAction Ignore).&quot;1931709068&quot; -ne 0) {
            # Update API issue: https://learn.microsoft.com/en-us/windows/release-health/status-windows-11-23h2#3351msgdesc
            $hotFixKirUrl=&quot;https://download.microsoft.com/download/3944f364-6483-49ab-af0d-3e2bd80dedaf/Windows%2011%2022H2%20KB5039302%20240711_20301%20Known%20Issue%20Rollback.msi&quot;
            try {
                write-host (&quot;Try to download KIR file to bring Windows Update API back&quot;)
                (New-Object System.Net.WebClient).DownloadFile($hotFixKirUrl, &quot;$env:temp\KIRKB5039302.msi&quot;)
                Start-Process msiexec.exe -Wait -ArgumentList &apos;/I $env:temp\KIRKB5039302.msi /quiet&apos;
                if (-not (Test-Path &quot;HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides&quot;)) {
                    New-Item -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides&quot; -Force -ErrorAction SilentlyContinue
                }
                New-ItemProperty -Path &quot;HKLM:\SYSTEM\CurrentControlSet\Policies\Microsoft\FeatureManagement\Overrides&quot; -Name &quot;1931709068&quot; -Value 0 -Force -ErrorAction SilentlyContinue
            } catch {
                write-host (&quot;Your system is possible affected by a known issue regarding the Windows Update API. Installing a rollback was not possible due to an error: $_&quot;)
                throw $_
            }
            # A reboot is required
            write-host(&quot;Known issue recovery was applied to the system, but no updates. A restart is required before the next update will work. https://learn.microsoft.com/en-us/windows/release-health/status-windows-11-23h2#3351msgdesc&quot;)
        } else {
            write-host (&quot;The KIR installation is installed. If this is not working, another issue prevents the update process: $_&quot;)
            throw $_
        }
    }
}

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description>
        <pubDate>Thu, 01 Aug 2024 00:00:00 +0200</pubDate>
        <link>https://blog.itprocloud.de/Windows-Update-API-issue-0x8002802B_TYPE_E_ELEMENTNOTFOUND/</link>
        <guid isPermaLink="true">https://blog.itprocloud.de/Windows-Update-API-issue-0x8002802B_TYPE_E_ELEMENTNOTFOUND/</guid>
        
        
        <category>Windows Virtual Desktop</category>
        
        <category>Azure Virtual Desktop</category>
        
      </item>
    
  </channel>
</rss>
