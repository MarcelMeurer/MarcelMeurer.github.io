<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logos/icon.png">

<title>WVD Admin - A native administration Gui for Windows Virtual Desktop | ITProCloud Blog</title>

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>WVD Admin - A native administration Gui for Windows Virtual Desktop | ITProCloud Blog</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="WVD Admin - A native administration Gui for Windows Virtual Desktop" />
<meta name="author" content="mm" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Windows Virtual Desktop administration" />
<meta property="og:description" content="Windows Virtual Desktop administration" />
<meta property="og:site_name" content="ITProCloud Blog" />
<meta property="og:image" content="/assets/images/WVDAdmin-01.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-11-02T00:00:00+01:00" />
<script type="application/ld+json">
{"url":"/Windows-Virtual-Desktop-Admin/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logos/itpc-logo-bottom-text.png"},"name":"mm"},"headline":"WVD Admin - A native administration Gui for Windows Virtual Desktop","dateModified":"2019-11-02T00:00:00+01:00","datePublished":"2019-11-02T00:00:00+01:00","author":{"@type":"Person","name":"mm"},"description":"Windows Virtual Desktop administration","image":"/assets/images/WVDAdmin-01.png","mainEntityOfPage":{"@type":"WebPage","@id":"/Windows-Virtual-Desktop-Admin/"},"@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

<!--- cookie banner --->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />

<link href="/assets/css/screen.css" rel="stylesheet">

<link href="/assets/css/main.css" rel="stylesheet">

<script src="/assets/js/jquery.min.js"></script>

</head>




<body class="layout-page">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
    <img src="/assets/images/logos/itpc-logo-bottom-text.png" alt="ITProCloud Blog">
    </a>
    <!-- End Logo -->

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Home</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="/about">About</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="#allTags">Show all tags</a>
                </li>
	
				
				
					
						<li class="nav-item">
						<a class="nav-link" href="/categories#Azure-WebApp">Azure WebApp (3)</a>
						</li>
						
					
						<li class="nav-item">
						<a class="nav-link" href="/categories#Azure-VM">Azure VM (2)</a>
						</li>
						
					
						<li class="nav-item">
						<a class="nav-link" href="/categories#PowerShell">PowerShell (7)</a>
						</li>
						
					
				
								

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://twitter.com/MarcelMeurer"><i class="fab fa-twitter"></i></a>
                </li>
                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://www.linkedin.com/in/marcel-meurer-15b46b98"><i class="fab fa-linkedin"></i></a>
                </li>
                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://github.com/MarcelMeurer"><i class="fab fa-github"></i></a>
                </li>
                </li>
                <li class="nav-item">
                <a target="_blank" class="nav-link" href="mailto:marcel.meurer@sepago.de?subject=Request%20from%20ITProCloud.de"><i class="far fa-envelope"></i></a>
                </li>


                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->

<div class="site-content">

<div class="container">

<!-- Site Title
================================================== -->
<div class="mainheading">
    <h1 class="sitetitle">ITProCloud Blog</h1>
    <p class="lead">
        This is my personal website, which I maintain to support the cloud community. ITProCloud.de is the label I use for tests and demonstrations. ITProCloud.de is not a company in the business sense.
    </p>
</div>

<!-- Content
================================================== -->
<div class="main-content">
    <section>
    <div class="section-title">
        <h2><span>WVD Admin - A native administration Gui for Windows Virtual Desktop</span></h2>
    </div>

    <div class="article-post">
    <h1 id="windows-virtual-desktop-administration">Windows Virtual Desktop administration</h1>

<p><strong>Important for prior 1.2.1 users: Check this <a href="#v121-note">note</a></strong></p>

<p>Windows Virtual Desktop is generally available and under continuous improvement. There was the time before Ignite 2019 where no administration GUI was publicly available. This changed with Ignite. The PG of Remote Desktop services releases an in-portal configuration for Windows Virtual Desktop which looks very nice and has a lot of configurable options. See <a href="https://twitter.com/RDS4U/status/1189773044094361601">https://twitter.com/RDS4U/status/1189773044094361601</a> for a preview or check it out in the Azure portal.</p>

<p>Sometimes it helps to have a native GUI to make some configuration. Therefore I build a tool to do this and last night I finished the project (in the current version) and provide it as a community tool for WVD.</p>

<p>The current version supports a lot of configuration and administration capabilities. You can:</p>

<ul>
  <li>Add, edit and delete host pools</li>
  <li>Add, edit and delete application groups</li>
  <li>Add, edit and delete application and desktop (you can add a new app with the Windows file-open-dialog)</li>
  <li>Add a list of users to applications or a desktop (separated by ;)</li>
  <li>Send messages to a single user and users on a specific session host</li>
  <li>Logoff single users or all users of a specific session host</li>
  <li>Start and deallocate session hosts (the Azure VM behind)</li>
  <li>Delete session hosts and the VMs in Azure including disks and nics</li>
  <li>Create an image of a template VM without destroying the template</li>
  <li>Rollout a number of new session hosts based on a template image - including domain join and WVD installation and registration (comparable to Citrix MCS)</li>
  <li>Rollout VM Scale Sets</li>
  <li>Start and deallocate Scale Set instances</li>
  <li>Re-image Scale Set instances</li>
  <li>Add or remove Scale Set instances</li>
  <li>and some more things</li>
</ul>

<h1 id="demo-video">Demo video</h1>

<iframe width="560" height="315" src="https://www.youtube.com/embed/g9T0mO1gH9Y" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
<h1 id="installation">Installation</h1>

<p><strong>Download  <a href="../assets/files/WVDAdmin.msi">WVDAdmin.msi</a> and install the application on your Windows client or on a template VM for your WVD.</strong></p>

<h2 id="versions">Versions</h2>

<p>1.5.3.00		Fix: Improvement updating the treeview</p>

<p>1.5.0.00		Add:  <a href="https://blog.itprocloud.de/Windows-Virtual-Desktop-Spring-Update,-Spring-Release">Supporting the WVD Spring Release / Spring Update</a> ; Some user operations from the session grid are now async; Fix: Spontaneous resize of the windows if data are reloaded</p>

<p>1.4.9.00		Add: Filter users, session hosts and host pools in the overview of sessions</p>

<p>1.4.8.00		Add: Support to add users by groups from Azure Active Directory, including an AAD browser (check my <a href="https://blog.itprocloud.de/Windows-Virtual-Desktop-Add-Users-and-Groups-to-WVD/">blog post</a> and configure the service principal to use this feature)</p>

<p>1.4.6.00		Add: New VM sizes; all new scale sets are deployed as really scalable version (up to 600 instances each)</p>

<p>1.4.4.00		Fix: Service Principal Keys with some special characters are working now; Add: Faster loading of resources from WVD and Azure backend</p>

<p>1.4.2.00		Add: Support for NVv4 VM sizes (based on AMD Radeon Instinct  MI25-GPU); support to set custom Azure tags for resources while deploying resources</p>

<p>1.4.0.00		Fix: From an older version, disks are deployed as standard-hdd even if premium-disk was selected; Change: Connection views are now located parallel to the logging list on the bottom (tenant-view); Add: Function to check for an updated version via <a href="../assets/files/WVDAdmin.xml">https://blog.itprocloud.de/assets/files/WVDAdmin.xml</a></p>

<p>1.3.6.00		Add: New tag for session hosts: WVD.Path - used by <a href="http://loganalytics.sepago.com/">Azure Monitor for WVD</a> and <a href="https://github.com/MarcelMeurer/Project-MySmartScale">Azure Autoscale for WVD - aka Project MySmartScale</a> if an installed language pack conflicts with the Microsoft RDAgent (read this <a href="https://blog.itprocloud.de/Windows-Virtual-Desktop-Language-Packs-Detecting-Host-Pool-and-Tenant-Name/">post</a> to learn more)</p>

<p>1.3.5.00		Add: Allow an local admin to mirror a user session (WVDAdmin needs direct access to the session host via RDP)</p>

<p>1.3.4.00		Add: Networks are now listed as VNET/SUBNET in the rollout tab</p>

<p>1.3.3.00		Add: Support for a special mode if your WVD tenant and the session hosts in two different Azure Active Directory tenants</p>

<p>1.3.1.00		Fix: WVDAdmin crashed if 1.3.0 is your first version of WVDAdmin (HKEY_CURRENT_USER\Software\ITProCloud doesn’t exist while checking for multi-tenancy mode)</p>

<p>1.3.0.00		Add: AAD multi-tenancy mode (drop down list to handle different AADs) - <a href="https://blog.itprocloud.de/Windows-Virtual-Desktop-Windows-Virtual-Desktop-Administration-for-CSP-and-Consulting-Partners/">https://blog.itprocloud.de/Windows-Virtual-Desktop-Windows-Virtual-Desktop-Administration-for-CSP-and-Consulting-Partners</a></p>

<p>1.2.8.00		Add: If you click a tenant a tenant wide list of sessions is listed.  Logoff or send messages to multiple sessions</p>

<p>1.2.7.00		Add: The main window of the application is now resizeable</p>

<p>1.2.5.00		Add: Support for Scale Sets (with normal and ephemeral disks) -&gt; see below</p>

<p>1.2.4.00		Add: Support for availability sets</p>

<p>1.2.3.00		Add: Support for automatic and static assigned host pools</p>

<p>1.2.1.00		<a name="v121-note"></a>Fix: Logging of rollout parameter by Azure custom extension is removed to avoid logging secrets</p>

<p>1.0.0.30		Fix: Rollout - OU can now be empty to join the default OU</p>

<p>1.0.0.29		Add: Supporting “special license mode” to save up to 50% on compute-cost (<a href="https://docs.microsoft.com/en-us/azure/virtual-desktop/apply-windows-license">https://docs.microsoft.com/en-us/azure/virtual-desktop/apply-windows-license</a>)</p>

<p>1.0.0.26		Add: Template VM can now be a VM with a standard disk (non-managed)</p>

<p>1.0.0.25		Fix: If you delete a VM the OS disk will deleted as well</p>

<p>1.0.0.23		Support for ephemeral  disks</p>

<p>1.0.0.22		First published version - without auto-update of WVD Admin</p>

<p><strong>Important for prior 1.2.1 users:</strong> I removed the logging of the Azure custom extension so that from version 1.2.1, no secrets are logged to “<em>c:\WindowsAzure\Logs\Plugins\Microsoft.Compute.CustomScriptExtension\*</em>”. I recommend to use the new version and to remove the logs from older session hosts (or to re-deploy these hosts). I found these logs while checking what other services are running on an Azure VM.</p>

<h3 id="support-for-vm-scale-sets">Support for VM Scale Sets</h3>

<p>From version 1.2.5, I support working with VM Scale Sets. A Scale Set can have several instances, which are the VMs / session hosts. There are some essential things you have to know if you use VM Scale Set with WVDAdmin and WVD itself:</p>

<ul>
  <li>Build a Scale Set with WVDAdmin. Select an image, right-click and select “Create session host from image”. Check “Rollout as VM Scale Set”</li>
  <li>You can use regular disks and ephemeral disks. If you use ephemeral disks, you cannot deallocate the instances of your Scale Set. You have to delete the instances</li>
  <li>Today you can not use ultra disks</li>
  <li>You can add and remove instances with WVDAdmin or in the Azure Portal. New instances will join the domain and WVD</li>
  <li>A new instance can only join WVD if the session host with the new name doesn’t exist. If you delete instances, the session host entry will also be removed</li>
  <li>You can re-image single instances or all instances of a Scale Set. After that, the instances are “clean” as at the first rollout</li>
  <li>Adding instances or re-imaging assumes that the Scale Set configuration (which is a custom script extension) has a valid WVD token to join new instances to WVD. While WVD provides only one token per host pool and that the token can be expiring, you can update the token with a right-click on the Scale Set and select “Update WVD token”. The max. lifetime of a token is 59 days</li>
  <li>Unfortunately, change the source image for a VM Scale Set. So if you want to update the image for a host pool, take these steps:
    <ul>
      <li>Rollout a new Scale Set based on the new image</li>
      <li>Disable new logons for the old session host from the previous Scale Set</li>
      <li>Test the host pool based on the new Scale Set</li>
      <li>If no user logged on to the ancient Scale Set, remove all instances from the Scale Set (this deletes the session hosts in WVD as well)</li>
      <li>Remove the Scale Set</li>
    </ul>
  </li>
  <li>Please feel free to give feedback</li>
</ul>

<h3 id="support-for-ephemeral--disks">Support for ephemeral  disks</h3>

<p>You can now rollout your session hosts with  ephemeral  disks. Ephemeral  disks are running on the Azure hypervisor and not stored in the fabric. This has some advantages:</p>

<ul>
  <li>There are no storage costs (!)</li>
  <li>A very high data throughput because the disks exist on the hypervisor</li>
  <li>See <a href="https://twitter.com/michawets">@MichaWets</a>   blog post for more information:  <a href="https://www.cloud-architect.be/2019/07/15/windows-virtual-desktop-running-on-ephemeral-os-disks/">https://www.cloud-architect.be/2019/07/15/windows-virtual-desktop-running-on-ephemeral-os-disks/</a></li>
</ul>

<p>Please note:</p>

<ul>
  <li>You can not deallocate a VM with this disk type (because the disk cannot be stored) - you have to delete the VM (and to rollout a new one instead of starting a “normal” VM)</li>
  <li>Not each VM size can be used and there are limitations of the disk size (image size for rollout) based on the VM size: Example: Max  ephemeral  disk size for  Standard_D4s_v3  is 64 GByte while a  Standard_D8s_v3 can have up to 128 GByte. See <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/sizes-general">https://docs.microsoft.com/en-us/azure/virtual-machines/linux/sizes-general</a></li>
  <li>If the Azure hypervisor fails your session host will fail as well and can not be re-deployed automatically</li>
</ul>

<p><img src="../assets/images/WVDAdmin/documentation-014.png" alt="documentation-001" /></p>

<h2 id="configuration">Configuration</h2>

<h2 id="service-principal-functional-account">Service principal (functional account)</h2>

<p>To work with the GUI you need a service principal (function account) with the permission to administrate your WVD tenant or tenants. I decide to use a service principal at this time to avoid confusion if my Azure Ad user is only a guest account in the WVD tenant I have to administrate.</p>

<p>To create a service principal go to your Azure Ad -&gt; App registration -&gt; New registration and type a name for your principal like “ svc_WVDAdmin” and press “register”.</p>

<p><img src="../assets/images/WVDAdmin/documentation-001.png" alt="documentation-001" /></p>

<p>Click on “certificates &amp; secrets”. Click “new client secret”, select a validity period and a description (like “Key01”). Press “add”.</p>

<p><img src="../assets/images/WVDAdmin/documentation-002.png" alt="documentation-002" /></p>

<p>Copy the generated key directly - it will never be displayed again. Note the key for later.</p>

<p><img src="../assets/images/WVDAdmin/documentation-003.png" alt="documentation-003" /></p>

<p>To use WVDAdmin with the AAD-Browser feature to select users and groups and to be prepared for the  <em>WVD Spring Update</em> (expected in H1/2020) the service principal need two API permissions:</p>

<p>API Permissions: Add the permission “Azure Active Directory Graph” -&gt; Application Permission -&gt; Directory.Read.All
<img src="../assets/images/WVDAdmin/SP-PermissionToReadDirectoryObjects-01.png" alt="AADBrowser" /></p>

<p>Add the permission “Microsoft Graph” -&gt; Application Permission -&gt; Directory.Read.All</p>

<p><img src="../assets/images/WVDAdmin/SP-PermissionToReadDirectoryObjects-01b.png" alt="AADBrowser" /></p>

<p>To consent the permission and administrator of Azure AD have to grant this:</p>

<p><img src="../assets/images/WVDAdmin/SP-PermissionToReadDirectoryObjects-02.png" alt="AADBrowser" /></p>

<p>Go to “Overview”. Note the “Application (client) ID” and the “Directory (tenant) ID” as well.</p>

<p><img src="../assets/images/WVDAdmin/documentation-004.png" alt="documentation-004" /></p>

<p>You now have all data for your service principal:</p>

<ul>
  <li>Tenant id</li>
  <li>Service principal id (application id)</li>
  <li>Service principal key</li>
</ul>

<h2 id="wdv-permissions-pre-spring-release">WDV permissions (pre-Spring release)</h2>

<p>To  use WVDAdmin you need at least an existing WVD tenant. If you new to WVD follow this article to create a WVD tenant:  <a href="https://docs.microsoft.com/en-us/azure/virtual-desktop/tenant-setup-azure-active-directory">https://docs.microsoft.com/en-us/azure/virtual-desktop/tenant-setup-azure-active-directory</a></p>

<p>You have to use PowerShell to give the WVD the appropriated permission:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nf">Import-Module</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">Microsoft.RDInfra.RDPowerShell</span><span class="w">
</span><span class="c"># log on with an administrative user account to your </span><span class="w">
</span><span class="nf">Add-RdsAccount</span><span class="w"> </span><span class="nt">-DeploymentUrl</span><span class="w"> </span><span class="s2">"https://rdbroker.wvd.microsoft.com"</span><span class="w">  

</span><span class="c"># list rds tenants</span><span class="w">
</span><span class="nf">Get-RdsTenant</span><span class="w">

</span><span class="c"># give your service principal the right permission</span><span class="w">
</span><span class="nf">New-RdsRoleAssignment</span><span class="w"> </span><span class="nt">-TenantName</span><span class="w"> </span><span class="s2">"Builder City"</span><span class="w"> </span><span class="nt">-RoleDefinitionName</span><span class="w"> </span><span class="s2">"RDS Owner"</span><span class="w"> </span><span class="nt">-ApplicationId</span><span class="w"> </span><span class="nx">89050a12-xxxx-xxxx-xxxx-000000000000</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="../assets/images/WVDAdmin/documentation-005.png" alt="documentation-005" /></p>

<h2 id="azure-resource-permissions">Azure resource permissions</h2>

<p>To image template VMs and to rollout new session hosts the service principal needs permission to the resource groups containing your session hosts (or are the target for these).</p>

<p>Open the Azure portal and go to the resource groups. Go into each resource group, click “Access control (IAM)” -&gt; select “Add” -&gt; Add role assignment. Select “contributor” (“owner” for resource groups you want to use for the <strong>Spring Release</strong> to allow adding users and groups) and search in “select” for your service principal name. Click the principal and save the settings.</p>

<p><strong>Note:</strong>To use WVDAdmin with the <em>WVD Spring Release</em>(expected in H1/2020) the service principal needs the “<strong>Owner</strong>” Role to give users permissions to access the desktops and apps.</p>

<p><img src="../assets/images/WVDAdmin/documentation-006.png" alt="documentation-006" /></p>

<p>Do the same for the other resource groups. It’s a good way to have several resource groups:</p>

<ul>
  <li>For each tenant or host pool</li>
  <li>For template VMs</li>
  <li>For the created images</li>
</ul>

<p>The service principal must have permissions to your virtual network (vnet) to assign new VMs to the right subnet. Go to your vnet, click “Access control (IAM)” -&gt; select “Add” -&gt; Add role assignment. Select “contributor” and search in “select” for your service principal name. Click the principal and save the settings.</p>

<p><img src="../assets/images/WVDAdmin/documentation-007.png" alt="documentation-007" /></p>

<h2 id="prepare-your-normal-active-directory">Prepare your “normal” Active Directory</h2>

<p>Today each session host must be part of a “legacy” active directory domain (or have to use the domain services). To add new session hosts unattended we need two more things:</p>

<ul>
  <li>An administrative user account with the permission to add a computer object to the active directory domain</li>
  <li>A file share with a configuration script and the WVD agent software</li>
</ul>

<p>Create an administrative account to join computer objects to the domain</p>

<p>Open “Active Directory Users and Computers” and create a user object with a complex password and set a password to “never expire” (if you fine with this). I added the user srv_WVD-Join@itprocloud.de.</p>

<p>Open the menu “View” and select “Advanced Features”. Create or go to the OU where do you want to have your WVD session hosts in. Right-click the OU, select security and add your account with read/write/… permission.</p>

<p><img src="../assets/images/WVDAdmin/documentation-008.png" alt="documentation-008" /></p>

<p>Please note the OU canonical name. In my case: “OU=WVD,OU=Azure,OU=Site,OU=Servers,OU=Sys,OU=Organisation,DC=ITProCloud,DC=test”</p>

<h2 id="create-a-file-share">Create a file share</h2>

<p><em>Hint: Alternatively, you can use Azure blob storage to store the script. Make the blob storage read-only and use the URL as rollout script-path. E.g.: https://sharedservices01.blob.core.windows.net/wvd</em></p>

<p>Create a file share for the configuration script (which adds new session hosts to the domain and install the WVD agent). Give everyone at least read permissions. Set the NTFS permissions to everyone and read. This is necessary while during the first startup the VM extension tries to execute the script. In this process, the file share is accessed anonymously.</p>

<p><img src="../assets/images/WVDAdmin/documentation-009.png" alt="documentation-009" /></p>

<p><img src="../assets/images/WVDAdmin/documentation-010.png" alt="documentation-010" /></p>

<p>Place the following files in this share:</p>

<ul>
  <li><a href="https://blog.itprocloud.de/assets/files/AutoUpdate/Scripts/ITPC-WVD-Image-Processing.ps1.txt">ITPC-WVD-Image-Processing.ps1</a> (rename the download to .ps1)</li>
  <li><a href="https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RWrmXv">Microsoft.RDInfra.RDAgent.msi</a> (rename the file)</li>
  <li><a href="https://query.prod.cms.rt.microsoft.com/cms/api/am/binary/RWrxrH">Microsoft.RDInfra.RDAgentBootLoader.msi</a> (rename the file)</li>
</ul>

<p>Make sure that you rename the files to fit the list above (without version numbers).</p>

<p><img src="../assets/images/WVDAdmin/documentation-011.png" alt="documentation-011" /></p>

<p><strong>Important:</strong> If you are using Windows Server <strong>2019</strong> as file share make sure that anonymous file share access is enabled. Create a GPO for the session hosts containing the following configurations:</p>

<ul>
  <li>Security Options:
    <ul>
      <li>Accounts: Guest Account Status: Enabled</li>
      <li>Network access: Let Everyone permissions apply to anonymous users: Enabled</li>
      <li>Network access: Do not allow anonymous enumeration of SAM accounts and shares: Disabled</li>
    </ul>
  </li>
</ul>

<h1 id="configure-wvdadmin">Configure WVDAdmin</h1>

<p>Please start WVDAdmin. Before you load WVD and Azure data copy the Azure tenant id, service principal id and service principal key into the welcome tab. Press save and load the data by clicking “Reload all”.</p>

<p>You are now able to administrate WVD, create images from template VMs and rollout new session hosts.</p>

<p>The first time you want to rollout new session hosts you have to enter some information from your Active Directory and file share configuration from above:</p>

<p><img src="../assets/images/WVDAdmin/documentation-012.png" alt="documentation-012" /></p>

<p>Local Admin and local pw. are the local administrator account credentials which you can enter at this time.</p>

<p><img src="../assets/images/WVDAdmin/documentation-013.png" alt="documentation-013" /></p>

<h1 id="building-an-image">Building an image</h1>

<p>You can rollout VMs and VM Scale Set with images created by WVDAdmin. These images contain the logic to join the AD domain and WVD.</p>

<p>You can simple create an image from a template VM. The template VM must part of your AD like a normal client. You have not to sysprep or to normalize this template VM. Use the same template VM for Windows and application updates.</p>

<p>Following these steps to build your template:</p>

<ul>
  <li>Install a VM in the Azure portal. Select the right OS (like Windows 10 Enterprise for Virtual Desktops)</li>
  <li>Make all Windows updates</li>
  <li>Join the VM to your AD</li>
  <li>Install your application</li>
  <li>Make your customizing (like installing language packages)</li>
  <li>Shutdown the template VM</li>
</ul>

<p>To create the image open WVDAdmin and</p>

<ul>
  <li>Navigate to the Azure template VM (Azure -&gt; Virtual Machines -&gt; RG -&gt; VM)</li>
  <li>Right-click -&gt; “Create a template image”</li>
  <li>Select the resource group to store the image</li>
  <li>Correct the script-path if necessary</li>
  <li>Press “Capture”</li>
</ul>

<p>You can and should reuse the template VM for new updates and applications. After these changes shut down the template VM and create a new image .</p>

<h1 id="troubleshooting">Troubleshooting</h1>

<p>The image is not created. An error message occurs:</p>

<ul>
  <li>Check if your template VM part of the AD</li>
  <li>If your file server Windows Server 2019, read above</li>
  <li>Check if you have set the NTFS and share permission correctly</li>
  <li>Azure portal: Go to the temp VM (next to the template VM) and check the state of the extension installation. There should be an error message like script not found; access denied, etc.</li>
  <li>Have you renamed the RD agent and bootloader?</li>
  <li>Is the script saved correctly: ITPC-WVD-Image-Processing.ps1 not ITPC-WVD-Image-Processing.ps1.txt</li>
  <li>Don’t forget to delete the temp VM and temp disk to avoid costs</li>
  <li>Make sure that your template VM uses managed disk</li>
  <li>An endless loop of “Waiting for the temporary vm (power off)” which results in an error after 30 minutes: Something goes wrong with sysprep. You can check the sysprep log in %WinDir%\system32\Sysprep\Panther on the temporary VM. 
This is often caused by Sysprep and installed language packs.<br />
Workaround: Delete all user profiles except the logged in user and default users: Press Win+R, type “SystemPropertiesAdvanced”, Advanced -&gt; Settings</li>
  <li>The script generates additional log files in %WinDir%\System32\LogFiles</li>
  <li>NEW: An endless loop of “Waiting for the temporary vm (power off)” : Update to the newest PowerShell script for generalizing: <a href="https://blog.itprocloud.de/assets/files/AutoUpdate/Scripts/ITPC-WVD-Image-Processing.ps1.txt">ITPC-WVD-Image-Processing.ps1</a></li>
</ul>

<p>Feel free to use it and download the 64-bit Windows application “WVD Admin” from here: <a href="../assets/files/WVDAdmin.msi">WVDAdmin.msi</a></p>


    </div>

    
</section>
</div>


    
</div>

<!-- Categories Jumbotron
================================================== -->
<div id="allTags" class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore by tags <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="/categories#Azure-WebApp">Azure WebApp (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-VM">Azure VM (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#PowerShell">PowerShell (7)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-Monitor">Azure Monitor (5)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Log-Analytics">Log Analytics (5)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-AD">Azure AD (4)</a>
                
                    <a class="mt-1 mb-1" href="/categories#OneDrive">OneDrive (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-IoT">Azure IoT (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-Functions">Azure Functions (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure-Marketplace">Azure Marketplace (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Azure">Azure (2)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Windows-Virtual-Desktop">Windows Virtual Desktop (11)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Events">Events (2)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-5 col-sm-5 text-center text-lg-left">
                Copyright © 2020 ITProCloud Blog 
            </div>
            <div class="col-md-4 col-sm-4 text-center text-lg-left">
                <a href="/Impressum">Impressum/Imprint</a> - 
                <a href="/privacyDe">Datenschutz</a> - 
				<a href="/privacyEn">Privacy</a>
            </div>
            <div class="col-md-3 col-sm-3 text-center text-lg-right">    
                <a target="_blank" href="https://www.wowthemes.net/mediumish-free-jekyll-template/">Mediumish Jekyll Theme</a> by WowThemes.net
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>



<script src="/assets/js/ie10-viewport-bug-workaround.js"></script> 



<!-- Start Cookie Plugin -->
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script>
<script>
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#eaf7f7",
      "text": "#5c7291"
    },
    "button": {
      "background": "#56cbdb",
      "text": "#ffffff"
    }
  },
  "position": "bottom-right",
  "content": {
    "message": 'This website uses cookies to ensure you get the best experience on our website.<br/><a href="/privacyEn">Privacy policy</a><br/><br/>Diese Website verwendet Cookies, um dir mehr Benutzerfreundlichkeit zu bieten. Mit der Nutzung dieser Website stimmst du der Verwendung von Cookies zu.<br/><a href="/privacyDe">Datenschutzerklärung</a><br/><br/> ',
    "href": "/privacyEn"
  }
});
</script>
<!-- End Cookie Plugin -->

</body>
</html>
